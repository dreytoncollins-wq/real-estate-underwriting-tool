<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Institutional Underwriting Platform | Real Estate–Backed Private Credit</title>
  <style>
    :root{
      --bg:#060b18;
      --panel:#0b132a;
      --panel2:#0a1124;
      --card:#0d1733;
      --line:rgba(255,255,255,.10);
      --text:#eaf0ff;
      --muted:#a8b6d9;
      --accent:#7aa2ff;
      --accent2:#c5d3ff;
      --good:#42d392;
      --warn:#f6c177;
      --bad:#ff6b6b;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color:var(--text);
      background:
        radial-gradient(1000px 600px at 18% 8%, rgba(122,162,255,.16), transparent 55%),
        radial-gradient(900px 600px at 75% 20%, rgba(66,211,146,.10), transparent 55%),
        linear-gradient(180deg, #040915, var(--bg) 35%, #030712);
    }
    a{color:inherit}
    .app{
      display:grid;
      grid-template-columns: 290px 1fr;
      min-height:100vh;
    }
    @media (max-width: 980px){
      .app{grid-template-columns: 1fr}
      .sidebar{position:sticky;top:0;z-index:10}
    }
    .sidebar{
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.03));
      border-right:1px solid var(--line);
      padding:14px 12px;
    }
    .brand{
      display:flex;align-items:center;gap:10px;
      padding:10px 10px 12px;
      border:1px solid var(--line);
      border-radius:16px;
      background: rgba(0,0,0,.20);
      box-shadow: 0 14px 45px rgba(0,0,0,.28);
      margin-bottom:12px;
    }
    .logo{
      width:36px;height:36px;border-radius:12px;
      background: linear-gradient(135deg, rgba(122,162,255,.55), rgba(66,211,146,.35));
      border:1px solid rgba(255,255,255,.15);
    }
    .brand h1{font-size:13px;margin:0}
    .brand .sub{font-size:10px;color:var(--muted);margin-top:2px}
    .nav{
      display:flex;flex-direction:column;gap:6px;
    }
    .nav button{
      width:100%;
      text-align:left;
      border:1px solid var(--line);
      background: rgba(0,0,0,.18);
      color:var(--text);
      padding:10px 10px;
      border-radius:14px;
      cursor:pointer;
      font-size:12px;
      display:flex;align-items:center;justify-content:space-between;gap:8px;
    }
    .nav button:hover{border-color: rgba(122,162,255,.55); background: rgba(122,162,255,.10)}
    .nav button.active{border-color: rgba(122,162,255,.85); background: rgba(122,162,255,.14)}
    .chip{font-size:10px;color:var(--muted);border:1px solid var(--line);padding:3px 7px;border-radius:999px}
    .main{
      padding:18px 16px 70px;
      max-width: 1220px;
      margin: 0 auto;
      width: 100%;
    }
    .topbar{
      display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;
      margin-bottom:12px;
    }
    .dealmeta{
      display:flex;gap:8px;flex-wrap:wrap;align-items:center;
    }
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.18);
      padding:7px 10px;border-radius:999px;
      font-size:11px;color:var(--muted);
    }
    .pill strong{color:var(--text);font-weight:600}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    .btn{
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      color:var(--text);
      padding:9px 11px;border-radius:12px;cursor:pointer;
      font-size:12px;display:inline-flex;align-items:center;gap:8px;
    }
    .btn:hover{border-color: rgba(122,162,255,.55); background: rgba(122,162,255,.12)}
    .btn.danger:hover{border-color: rgba(255,107,107,.65); background: rgba(255,107,107,.10)}
    .grid2{display:grid;grid-template-columns: 1fr 1fr; gap:12px}
    @media (max-width: 900px){ .grid2{grid-template-columns:1fr} }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius:18px;
      padding:14px;
      box-shadow: 0 14px 45px rgba(0,0,0,.22);
    }
    .card h2{font-size:13px;margin:0 0 10px;color:var(--accent2);letter-spacing:.2px}
    .card h3{font-size:12px;margin:14px 0 8px;color:#d7e1ff}
    .card p{margin:6px 0;color:var(--muted);font-size:12px}
    .small{font-size:11px;color:var(--muted)}
    .hr{height:1px;background:var(--line);margin:12px 0}
    label{display:block;font-size:11px;color:var(--muted);margin:10px 0 6px}
    input, select, textarea{
      width:100%;
      border:1px solid var(--line);
      background: rgba(0,0,0,.20);
      color:var(--text);
      padding:9px 10px;
      border-radius:12px;
      font-size:12px;
      outline:none;
    }
    textarea{min-height:80px;resize:vertical}
    input:focus, select:focus, textarea:focus{
      border-color: rgba(122,162,255,.65);
      box-shadow: 0 0 0 3px rgba(122,162,255,.12);
    }
    .row{display:flex;gap:10px}
    .row > *{flex:1}
    .hint{
      margin-top:6px;font-size:10px;color:var(--muted);
      opacity:.95
    }
    .callout{
      border:1px dashed rgba(122,162,255,.45);
      background: rgba(122,162,255,.08);
      padding:10px 10px;border-radius:14px;
      font-size:11px;color:var(--muted);
    }
    .warnbox{
      border:1px dashed rgba(246,193,119,.55);
      background: rgba(246,193,119,.10);
      padding:10px;border-radius:14px;
      font-size:11px;color:var(--muted);
    }
    .badbox{
      border:1px dashed rgba(255,107,107,.55);
      background: rgba(255,107,107,.10);
      padding:10px;border-radius:14px;
      font-size:11px;color:var(--muted);
    }
    .kpiGrid{display:grid;grid-template-columns: repeat(4, 1fr); gap:10px}
    @media (max-width: 1100px){ .kpiGrid{grid-template-columns: repeat(2, 1fr);} }
    .kpi{
      border:1px solid var(--line);
      background: rgba(0,0,0,.18);
      border-radius:14px;
      padding:10px;
    }
    .kpi .t{font-size:10px;color:var(--muted);margin-bottom:6px}
    .kpi .v{font-size:14px;font-family:var(--mono)}
    .kpi .s{margin-top:6px;font-size:10px}
    .tag{display:inline-flex;align-items:center;gap:6px}
    .dot{width:8px;height:8px;border-radius:50%}
    .good{color:var(--good)} .warn{color:var(--warn)} .bad{color:var(--bad)}
    .dot.good{background:var(--good)} .dot.warn{background:var(--warn)} .dot.bad{background:var(--bad)}
    .table{width:100%;border-collapse:collapse;font-size:11px}
    .table th,.table td{border-bottom:1px solid var(--line);padding:8px 6px;text-align:left;vertical-align:top}
    .table th{color:var(--muted);font-weight:600}
    .mono{font-family:var(--mono)}
    .nowrap{white-space:nowrap}
    .right{text-align:right}
    .rowBtns{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .page{display:none}
    .page.active{display:block}
    .footerNote{
      margin-top:12px;
      font-size:10px;color:var(--muted);
      opacity:.9
    }
    .printOnly{display:none}
    @media print{
      .sidebar,.actions,.noPrint{display:none !important}
      .printOnly{display:block}
      body{background:white;color:black}
      .main{max-width:none;margin:0;padding:0}
      .card{box-shadow:none;border:1px solid #ccc;background:white}
      input,select,textarea{border:1px solid #ccc;background:white;color:black}
      .kpi{background:white}
      .table th,.table td{border-bottom:1px solid #ccc}
    }
  </style>
</head>
<body>
<div class="app">
  <!-- SIDEBAR NAV -->
  <aside class="sidebar noPrint">
    <div class="brand">
      <div class="logo"></div>
      <div>
        <h1>Underwriting Platform</h1>
        <div class="sub">Bank-style discipline for private credit</div>
      </div>
    </div>

    <div class="nav" id="nav">
      <button data-page="p_deal" class="active">A. Deal Setup <span class="chip">Inputs</span></button>
      <button data-page="p_structure">B. Loan Structure & Pricing <span class="chip">Inputs</span></button>
      <button data-page="p_sources">C. Sources & Uses <span class="chip">Inputs</span></button>
      <button data-page="p_property">D. Property & Market <span class="chip">Inputs</span></button>
      <button data-page="p_hist">E. Historical Ops (T‑12) <span class="chip">Inputs</span></button>
      <button data-page="p_proforma">F. Pro Forma (Core) <span class="chip">Inputs</span></button>
      <button data-page="p_construction">G. Construction / Value‑Add <span class="chip">Inputs</span></button>
      <button data-page="p_sponsor">H. Sponsor / Guarantor Spread <span class="chip">Inputs</span></button>
      <button data-page="p_global">I. Global Cash Flow (Portfolio) <span class="chip">Inputs</span></button>
      <button data-page="p_stress">J. Stress / Downside <span class="chip">Inputs</span></button>
      <button data-page="p_legal">K. Collateral & Legal <span class="chip">Inputs</span></button>
      <button data-page="p_rating">L. Risk Rating <span class="chip">Policy</span></button>
      <button data-page="p_conditions">M. Conditions & Monitoring <span class="chip">Policy</span></button>
      <button data-page="p_outputs">N. Outputs (Summary & Memo) <span class="chip">Outputs</span></button>
      <button data-page="p_feedback">O. Underwriter Feedback <span class="chip">Improve</span></button>
    </div>

    <div class="hr"></div>
    <div class="small">
      <div class="callout">
        <strong>Workflow:</strong> Complete A→M inputs. Outputs update live. Use Export JSON for file-level audit trail.
      </div>
      <div class="footerNote">
        This tool is conservative by default; tighten assumptions rather than “optimizing” outcomes.
      </div>
    </div>
  </aside>

  <!-- MAIN -->
  <main class="main">
    <div class="topbar noPrint">
      <div class="dealmeta">
        <div class="pill">Deal: <strong id="hdrDeal">—</strong></div>
        <div class="pill">Product: <strong id="hdrProd">—</strong></div>
        <div class="pill">Rec: <strong id="hdrRec">—</strong></div>
        <div class="pill">Risk: <strong id="hdrRisk">—</strong></div>
      </div>
      <div class="actions">
        <!-- Inputs/Outputs mode toggle -->
<div class="mode-toggle" style="display:flex; gap:8px; align-items:center; margin-right:12px;">
  <button id="btnModeInputs" type="button" class="btn btn-secondary">Inputs</button>
  <button id="btnModeOutputs" type="button" class="btn btn-secondary">Outputs</button>
  <span id="modeBadge" style="font-size:12px; opacity:.8;">Mode: Inputs</span>
</div>

        <button class="btn" id="btnRecalc">Recalculate</button>
        <button class="btn" id="btnSave">Save</button>
        <button class="btn" id="btnExport">Export JSON</button>
        <button class="btn" id="btnImport">Import JSON</button>
        <button class="btn danger" id="btnClear">Clear</button>
        <button class="btn" id="btnPrint">Print Credit Summary</button>
      </div>
    </div>

    <!-- PAGES -->
    <section class="page active" id="p_deal">
      <div class="card">
        <h2>A. Deal Setup</h2>
        <p><strong>Purpose:</strong> Establish the underwriting file, borrower identity, and high-level deal context so all downstream calculations and memo outputs are properly labeled and auditable.</p>

        <div class="grid2">
          <div>
            <h3>Deal Identification</h3>
            <div class="row">
              <div>
                <label>Deal Name / Property</label>
                <input id="dealName" placeholder="e.g., 8509 Western Hills Blvd | Bridge Refi" />
                <div class="hint">Used on every output and exported JSON file name.</div>
              </div>
              <div>
                <label>Internal Deal ID</label>
                <input id="dealId" placeholder="e.g., 151-2025-123" />
              </div>
            </div>
            <div class="row">
              <div>
                <label>Underwriter</label>
                <input id="underwriter" placeholder="Name / initials" />
              </div>
              <div>
                <label>Date Underwritten</label>
                <input id="uwDate" type="date"/>
              </div>
            </div>

            <label>Borrower Entity Name</label>
            <input id="borrowerEntity" placeholder="Borrower LLC / SPV name" />

            <div class="row">
              <div>
                <label>State of Formation</label>
                <input id="borrowerState" placeholder="TX" />
              </div>
              <div>
                <label>Entity Type</label>
                <select id="entityType">
                  <option>LLC</option><option>LP</option><option>Corporation</option><option>Trust</option><option>Other</option>
                </select>
              </div>
            </div>

            <label>Guarantors (comma-separated)</label>
            <input id="guarantors" placeholder="Name 1; Name 2; ..." />

            <div class="row">
              <div>
                <label>Loan Product</label>
                <select id="loanProduct">
                  <option value="bridge">Bridge (Transitional)</option>
                  <option value="fixflip">Fix‑and‑Flip</option>
                  <option value="construction">Ground‑Up Construction</option>
                  <option value="commercial_bridge">Commercial Bridge</option>
                  <option value="land">Land Acquisition</option>
                  <option value="second_lien">Second Lien / Mezz</option>
                  <option value="dscr">DSCR / Investment Property</option>
                </select>
              </div>
              <div>
                <label>Recourse Type</label>
                <select id="recourse">
                  <option value="full">Full Recourse</option>
                  <option value="limited">Limited Recourse / Bad‑Boy</option>
                  <option value="non">Non‑Recourse</option>
                </select>
              </div>
            </div>

            <label>Loan Purpose</label>
            <select id="loanPurpose">
              <option>Acquisition</option>
              <option>Cash‑Out Refinance</option>
              <option>Rate/Term Refinance</option>
              <option>Construction</option>
              <option>Rehab / Value‑Add</option>
              <option>Bridge to Sale</option>
              <option>Bridge to Permanent Financing</option>
              <option>Other</option>
            </select>

            <label>Transaction Narrative (credit‑committee ready)</label>
            <textarea id="txNarr" placeholder="Describe the request, collateral, business plan, and why this loan exists now. Keep neutral and factual."></textarea>

            <div class="warnbox">
              <strong>Institutional standard:</strong> If the narrative cannot be stated clearly in 5–8 sentences (purpose, collateral, plan, exit, risks), it is typically not ready for approval.
            </div>
          </div>

          <div>
            <h3>Policy / Admin</h3>
            <div class="row">
              <div>
                <label>Target Closing Date</label>
                <input id="closeDate" type="date"/>
              </div>
              <div>
                <label>Pipeline Stage</label>
                <select id="stage">
                  <option>Screening</option><option>Pre‑Underwrite</option><option>Full Underwrite</option><option>Credit Committee</option><option>Approved</option><option>Closed</option><option>Declined</option>
                </select>
              </div>
            </div>

            <div class="row">
              <div>
                <label>Warehouse / Investor Facility</label>
                <input id="facility" placeholder="e.g., Warehouse Line A" />
              </div>
              <div>
                <label>Facility Funding %</label>
                <input id="cofPctFunded" type="number" min="0" max="100" step="0.1" value="80"/>
                <div class="hint">Portion of principal subject to cost-of-funds.</div>
              </div>
            </div>

            <div class="row">
              <div>
                <label>Cost of Funds (% annual)</label>
                <input id="cofRate" type="number" min="0" step="0.01" value="8.00"/>
              </div>
              <div>
                <label>Target Lender ROA (% over term)</label>
                <input id="targetROA" type="number" min="0" step="0.1" value="10.0"/>
              </div>
            </div>

            <div class="row">
              <div>
                <label>Target CoC (on lender equity, % over term)</label>
                <input id="targetCoC" type="number" min="0" step="0.1" value="18.0"/>
              </div>
              <div>
                <label>Minimum DSCR Policy (stabilized)</label>
                <input id="policyMinDSCR" type="number" min="0" step="0.01" value="1.20"/>
              </div>
            </div>

            <div class="callout">
              <strong>How to use:</strong> This tool will flag metrics under your policy thresholds and suggest conditions / structure tightening.
            </div>

            <div class="hr"></div>

            <h3>Quick Deal Completeness</h3>
            <div class="kpiGrid" id="kpiCompleteness"></div>

            <div class="footerNote">
              Tip: Complete the “Core 6” (loan amount, value, DS assumptions, sponsor liquidity, exit, diligence) before spending time refining projections.
            </div>
          </div>
        </div>
      </div>
    </section>

    <section class="page" id="p_structure">
      <div class="card">
        <h2>B. Loan Structure & Pricing</h2>
        <p><strong>Purpose:</strong> Define legal and economic terms (rate, amortization, fees, reserves, lien position). This drives lender economics, debt service, DSCR, and exit feasibility.</p>

        <div class="grid2">
          <div>
            <h3>Core Terms</h3>
            <div class="row">
              <div>
                <label>Requested Loan Amount ($)</label>
                <input id="loanAmount" type="number" min="0" step="1000" value="0"/>
              </div>
              <div>
                <label>Interest Type</label>
                <select id="interestType">
                  <option value="fixed">Fixed</option>
                  <option value="floating">Floating</option>
                </select>
              </div>
            </div>

            <div class="row">
              <div>
                <label>Note Rate (% annual)</label>
                <input id="noteRate" type="number" min="0" step="0.01" value="12.00"/>
              </div>
              <div>
                <label>Index / Spread (if floating)</label>
                <input id="indexSpread" placeholder="e.g., SOFR + 6.50%" />
              </div>
            </div>

            <div class="row">
              <div>
                <label>Term (months)</label>
                <input id="termMonths" type="number" min="1" step="1" value="12"/>
              </div>
              <div>
                <label>Interest‑Only Months</label>
                <input id="ioMonths" type="number" min="0" step="1" value="12"/>
              </div>
            </div>

            <div class="row">
              <div>
                <label>Amortization (years) (if amortizing)</label>
                <input id="amortYears" type="number" min="0" step="1" value="30"/>
              </div>
              <div>
                <label>Balloon at Maturity</label>
                <select id="balloon">
                  <option value="yes">Yes</option>
                  <option value="no">No (fully amortizing)</option>
                </select>
              </div>
            </div>

            <h3>Fees & Economics</h3>
            <div class="row">
              <div>
                <label>Origination Points (% of loan)</label>
                <input id="origPoints" type="number" min="0" step="0.01" value="2.00"/>
              </div>
              <div>
                <label>Other Fees ($)</label>
                <input id="otherFees" type="number" min="0" step="100" value="0"/>
              </div>
            </div>

            <div class="row">
              <div>
                <label>Exit Fee ($) (optional)</label>
                <input id="exitFee" type="number" min="0" step="500" value="0"/>
              </div>
              <div>
                <label>Extension Fee (% of loan) (optional)</label>
                <input id="extFeePct" type="number" min="0" step="0.01" value="0"/>
              </div>
            </div>

            <div class="row">
              <div>
                <label>Default Interest (% add‑on)</label>
                <input id="defaultAdd" type="number" min="0" step="0.25" value="5.00"/>
              </div>
              <div>
                <label>Late Fee (% of payment)</label>
                <input id="lateFeePct" type="number" min="0" step="0.1" value="5.0"/>
              </div>
            </div>

            <div class="callout">
              <strong>Interpretation:</strong> For bridge/value‑add, pricing alone does not solve structure risk. If leverage is high, require (i) tighter LTC, (ii) reserves, (iii) PG, (iv) covenants/cash management, and (v) realistic exit.
            </div>
          </div>

          <div>
            <h3>Lien Position & Payments</h3>
            <div class="row">
              <div>
                <label>Lien Position</label>
                <select id="lienPos">
                  <option value="1st">1st Lien</option>
                  <option value="2nd">2nd Lien</option>
                  <option value="mezz">Mezz / Equity‑like</option>
                </select>
              </div>
              <div>
                <label>Senior Debt Ahead ($)</label>
                <input id="seniorAhead" type="number" min="0" step="1000" value="0"/>
              </div>
            </div>

            <div class="row">
              <div>
                <label>Interest Reserve ($ held back)</label>
                <input id="interestReserve" type="number" min="0" step="1000" value="0"/>
              </div>
              <div>
                <label>Reserve Coverage Target (months)</label>
                <input id="reserveMonths" type="number" min="0" step="1" value="6"/>
              </div>
            </div>

            <div class="row">
              <div>
                <label>Escrows (Taxes/Insurance)</label>
                <select id="escrows">
                  <option value="none">None</option>
                  <option value="ti">T&amp;I Escrow</option>
                  <option value="full">Full Cash Management</option>
                </select>
              </div>
              <div>
                <label>Cash Management Trigger DSCR</label>
                <input id="cmTrigger" type="number" min="0" step="0.01" value="1.10"/>
              </div>
            </div>

            <div class="hr"></div>

            <h3>Calculated Payments (Audit‑Friendly)</h3>
            <div class="kpiGrid" id="kpiPayments"></div>

            <div class="hr"></div>

            <h3>Lender Economics (Over Term)</h3>
            <div class="kpiGrid" id="kpiEconomics"></div>

            <div class="warnbox">
              <strong>Common failure point:</strong> Underwriting the exit based on “best case” and not verifying takeout requirements (DSCR, LTV, sponsor liquidity, seasoning, and market cap rates).
            </div>
          </div>
        </div>
      </div>
    </section>

    <section class="page" id="p_sources">
      <div class="card">
        <h2>C. Sources & Uses</h2>
        <p><strong>Purpose:</strong> Validate sponsor equity at risk, ensure the budget is complete, identify gaps, and compute LTC and contingency adequacy. For construction/value‑add, the budget is a primary credit document.</p>

        <div class="grid2">
          <div>
            <h3>Uses (Budget Summary)</h3>
            <div class="row">
              <div>
                <label>Purchase Price ($)</label>
                <input id="purchasePrice" type="number" min="0" step="1000" value="0"/>
              </div>
              <div>
                <label>Closing Costs (Borrower) ($)</label>
                <input id="borClosing" type="number" min="0" step="500" value="0"/>
              </div>
            </div>

            <div class="row">
              <div>
                <label>Rehab / Construction Hard Costs ($)</label>
                <input id="rehabBudget" type="number" min="0" step="1000" value="0"/>
              </div>
              <div>
                <label>Soft Costs ($) (A&amp;E, permits, etc.)</label>
                <input id="softCosts" type="number" min="0" step="1000" value="0"/>
              </div>
            </div>

            <div class="row">
              <div>
                <label>Contingency (% of hard costs)</label>
                <input id="contPct" type="number" min="0" step="0.1" value="10.0"/>
              </div>
              <div>
                <label>Interest Carry (est.) ($) (if not reserved)</label>
                <input id="estCarry" type="number" min="0" step="1000" value="0"/>
              </div>
            </div>

            <div class="row">
              <div>
                <label>Leasing / TI / LC ($) (if applicable)</label>
                <input id="leasingCosts" type="number" min="0" step="1000" value="0"/>
              </div>
              <div>
                <label>CapEx Reserve ($/yr) (stabilized)</label>
                <input id="capexReserve" type="number" min="0" step="100" value="0"/>
              </div>
            </div>

            <label>Total Uses ($) (override if needed)</label>
            <input id="totalUses" type="number" min="0" step="1000" value="0"/>
            <div class="hint">If blank/zero, tool computes a total from line items above.</div>

            <div class="hr"></div>
            <h3>Sources</h3>
            <div class="row">
              <div>
                <label>Loan Proceeds ($)</label>
                <input id="srcLoan" type="number" min="0" step="1000" value="0"/>
                <div class="hint">Default = requested loan amount (set on page B).</div>
              </div>
              <div>
                <label>Sponsor Equity ($)</label>
                <input id="sponsorEquity" type="number" min="0" step="1000" value="0"/>
              </div>
            </div>

            <div class="row">
              <div>
                <label>Other Financing ($)</label>
                <input id="otherFin" type="number" min="0" step="1000" value="0"/>
              </div>
              <div>
                <label>Cash at Risk (%)</label>
                <input id="equityAtRiskPct" type="number" min="0" step="0.1" value="100"/>
                <div class="hint">If equity is borrowed or reimbursed, reduce accordingly.</div>
              </div>
            </div>

            <div class="callout">
              <strong>Interpretation:</strong> Sponsor equity that is not “real cash at risk” is not loss-absorbing capital. Underwrite it accordingly.
            </div>
          </div>

          <div>
            <h3>Budget Controls (Construction/Value‑Add)</h3>
            <div class="row">
              <div>
                <label>Draw Method</label>
                <select id="drawMethod">
                  <option value="reimb">Reimbursement (post‑work)</option>
                  <option value="adv">Advance (pre‑work)</option>
                  <option value="hybrid">Hybrid</option>
                </select>
              </div>
              <div>
                <label>Inspection Frequency</label>
                <select id="inspectFreq">
                  <option>Per Draw</option><option>Monthly</option><option>Milestones</option>
                </select>
              </div>
            </div>

            <div class="row">
              <div>
                <label>GC Contract Type</label>
                <select id="gcType">
                  <option>Not Provided</option>
                  <option>GMP</option>
                  <option>Fixed Price</option>
                  <option>Cost Plus</option>
                  <option>Owner‑Builder</option>
                </select>
              </div>
              <div>
                <label>Contingency Holder</label>
                <select id="contHolder">
                  <option>Lender Controlled</option>
                  <option>Borrower Controlled</option>
                  <option>Shared</option>
                </select>
              </div>
            </div>

            <div class="row">
              <div>
                <label>Permits in Hand?</label>
                <select id="permits">
                  <option value="no">No</option>
                  <option value="partial">Partially</option>
                  <option value="yes">Yes</option>
                </select>
              </div>
              <div>
                <label>Construction Start Date</label>
                <input id="startDate" type="date"/>
              </div>
            </div>

            <div class="row">
              <div>
                <label>Construction Duration (months)</label>
                <input id="constMonths" type="number" min="0" step="1" value="0"/>
              </div>
              <div>
                <label>Lease‑Up Duration (months)</label>
                <input id="leaseupMonths" type="number" min="0" step="1" value="0"/>
              </div>
            </div>

            <div class="hr"></div>
            <h3>Computed Gaps & Policy Flags</h3>
            <div class="kpiGrid" id="kpiSU"></div>

            <div class="badbox" id="gapBox" style="display:none"></div>

            <div class="footerNote">
              If Sources ≠ Uses: fix the gap before proceeding. “Assumed” money is not a source.
            </div>
          </div>
        </div>
      </div>
    </section>

    <section class="page" id="p_property">
      <div class="card">
        <h2>D. Property & Market</h2>
        <p><strong>Purpose:</strong> Document collateral characteristics, assess market liquidity, and support rent/sale/exit assumptions. For private credit, marketability and time-to-exit are core downside drivers.</p>

        <div class="grid2">
          <div>
            <h3>Collateral Description</h3>
            <div class="row">
              <div>
                <label>Property Address</label>
                <input id="propAddr" placeholder="Street, City, State" />
              </div>
              <div>
                <label>County / Submarket</label>
                <input id="submarket" placeholder="e.g., Tarrant / West FW" />
              </div>
            </div>

            <div class="row">
              <div>
                <label>Asset Type</label>
                <select id="assetType">
                  <option value="sfr">SFR / 1‑4</option>
                  <option value="multifamily">Multifamily</option>
                  <option value="office">Office</option>
                  <option value="retail">Retail</option>
                  <option value="industrial">Industrial</option>
                  <option value="mixed">Mixed‑Use</option>
                  <option value="land">Land</option>
                  <option value="other">Other</option>
                </select>
              </div>
              <div>
                <label>Occupancy Status</label>
                <select id="occupancy">
                  <option value="vacant">Vacant</option>
                  <option value="part">Partially Occupied</option>
                  <option value="inplace">Stabilized / In‑Place</option>
                </select>
              </div>
            </div>

            <div class="row">
              <div>
                <label>Year Built / Renovated</label>
                <input id="yearBuilt" placeholder="e.g., 1998 / 2022" />
              </div>
              <div>
                <label>Size (SF / Units)</label>
                <input id="size" placeholder="e.g., 12,500 SF or 24 units" />
              </div>
            </div>

            <label>Physical Condition (neutral)</label>
            <textarea id="condition" placeholder="Deferred maintenance, major systems, roof/HVAC, code issues, functional obsolescence..."></textarea>

            <label>Location Strengths / Weaknesses</label>
            <textarea id="locNotes" placeholder="Visibility, access, tenant base, competing supply, crime perception, barriers to entry..."></textarea>

            <div class="callout">
              <strong>Interpretation:</strong> If collateral has “thin buyer pool” characteristics (special purpose, tertiary market, heavy deferred maintenance), require additional cushion (lower leverage, more reserves, stronger PG).
            </div>
          </div>

          <div>
            <h3>Valuation & Market Inputs</h3>
            <div class="row">
              <div>
                <label>As‑Is Value (Appraisal/BPO) ($)</label>
                <input id="asIsValue" type="number" min="0" step="1000" value="0"/>
              </div>
              <div>
                <label>Stabilized/ARV Value ($)</label>
                <input id="arvValue" type="number" min="0" step="1000" value="0"/>
              </div>
            </div>

            <div class="row">
              <div>
                <label>Appraisal Date</label>
                <input id="appDate" type="date"/>
              </div>
              <div>
                <label>Appraiser / BPO Provider</label>
                <input id="appProv" placeholder="Firm name" />
              </div>
            </div>

            <h3>Market & Liquidity</h3>
            <div class="row">
              <div>
                <label>Market Vacancy Trend</label>
                <select id="mktVacTrend">
                  <option>Improving</option><option>Stable</option><option>Softening</option><option>Unknown</option>
                </select>
              </div>
              <div>
                <label>Supply Pipeline Risk</label>
                <select id="pipeline">
                  <option>Low</option><option>Moderate</option><option>High</option><option>Unknown</option>
                </select>
              </div>
            </div>

            <div class="row">
              <div>
                <label>Liquidity Score (1 best – 5 worst)</label>
                <input id="liqScore" type="number" min="1" max="5" step="1" value="3"/>
              </div>
              <div>
                <label>Time‑to‑Sell Assumption (months)</label>
                <input id="tts" type="number" min="0" step="1" value="6"/>
              </div>
            </div>

            <label>Comparable Rent Notes</label>
            <textarea id="rentComps" placeholder="Summarize rent comps, concessions, tenant quality, and support for pro forma rents."></textarea>

            <label>Comparable Sale Notes</label>
            <textarea id="saleComps" placeholder="Summarize sales comps supporting as-is and exit assumptions; cap rates; buyer pool."></textarea>

            <div class="hr"></div>
            <h3>Market Risk Scoring (Auto)</h3>
            <div class="kpiGrid" id="kpiMarket"></div>
          </div>
        </div>
      </div>
    </section>

    <section class="page" id="p_hist">
      <div class="card">
        <h2>E. Historical Operating Performance (T‑12 / In‑Place)</h2>
        <p><strong>Purpose:</strong> Establish a defensible baseline NOI and identify normalization adjustments. Historical statements are often “optimistic”; normalize to market vacancy, management, and reserves.</p>

        <div class="grid2">
          <div>
            <h3>Income</h3>
            <div class="row">
              <div>
                <label>Gross Scheduled Rent ($/yr)</label>
                <input id="grossRent" type="number" min="0" step="1000" value="0"/>
              </div>
              <div>
                <label>Other Income ($/yr)</label>
                <input id="otherIncome" type="number" min="0" step="100" value="0"/>
              </div>
            </div>

            <div class="row">
              <div>
                <label>Vacancy & Credit Loss (% of gross)</label>
                <input id="vacPct" type="number" min="0" max="100" step="0.1" value="5.0"/>
              </div>
              <div>
                <label>Mgmt Fee (% of EGI) (include even if owner‑managed)</label>
                <input id="mgmtPct" type="number" min="0" max="100" step="0.1" value="4.0"/>
              </div>
            </div>

            <h3>Operating Expenses</h3>
            <div class="row">
              <div>
                <label>Taxes ($/yr)</label>
                <input id="taxes" type="number" min="0" step="100" value="0"/>
              </div>
              <div>
                <label>Insurance ($/yr)</label>
                <input id="insurance" type="number" min="0" step="100" value="0"/>
              </div>
            </div>
            <div class="row">
              <div>
                <label>Repairs & Maintenance ($/yr)</label>
                <input id="repairs" type="number" min="0" step="100" value="0"/>
              </div>
              <div>
                <label>Utilities ($/yr)</label>
                <input id="utilities" type="number" min="0" step="100" value="0"/>
              </div>
            </div>
            <div class="row">
              <div>
                <label>Payroll / On‑Site ($/yr)</label>
                <input id="payroll" type="number" min="0" step="100" value="0"/>
              </div>
              <div>
                <label>Other Operating Expenses ($/yr)</label>
                <input id="otherOpex" type="number" min="0" step="100" value="0"/>
              </div>
            </div>

            <div class="row">
              <div>
                <label>Replacement Reserves ($/yr)</label>
                <input id="replReserves" type="number" min="0" step="100" value="0"/>
              </div>
              <div>
                <label>Normalization Adjustments ($/yr) (+ adds expense)</label>
                <input id="normAdj" type="number" step="100" value="0"/>
                <div class="hint">Example: add market mgmt, increase vacancy, remove one‑time income.</div>
              </div>
            </div>

            <div class="callout">
              <strong>Guidance:</strong> If actual vacancy is abnormally low, underwrite to market. If owner‑managed, include market mgmt fee. If reserves are missing, include them.
            </div>
          </div>

          <div>
            <h3>Normalized NOI Output</h3>
            <div class="kpiGrid" id="kpiHist"></div>

            <div class="hr"></div>
            <h3>Rent Roll (Optional – quick table)</h3>
            <p class="small">This is a lightweight rent roll. For institutional approval, attach the actual rent roll as an exhibit; use this to sanity-check totals.</p>
            <table class="table" id="rentRollTbl">
              <thead>
                <tr><th>Unit/Tenant</th><th class="right">Rent/mo</th><th class="right">Lease Exp</th><th>Notes</th><th class="right"> </th></tr>
              </thead>
              <tbody></tbody>
            </table>
            <div class="rowBtns">
              <button class="btn" id="addRR">Add Row</button>
              <button class="btn" id="sumRR">Update Gross Rent From Rent Roll</button>
            </div>

            <div class="footerNote">
              If rent roll totals differ from stated income, explain the discrepancy (vacancy, free rent, bad debt, concessions, month-to-month).
            </div>
          </div>
        </div>
      </div>
    </section>

    <section class="page" id="p_proforma">
      <div class="card">
        <h2>F. Forward‑Looking Pro Forma (Core Section)</h2>
        <p><strong>Purpose:</strong> Underwrite stabilized performance, exit value, and takeout feasibility. Assumptions must be defensible, conservative, and supported by comps. This section drives most “true risk.”</p>

        <div class="grid2">
          <div>
            <h3>Stabilized Income Assumptions</h3>
            <div class="row">
              <div>
                <label>Stabilized Gross Rent ($/yr)</label>
                <input id="stbGrossRent" type="number" min="0" step="1000" value="0"/>
              </div>
              <div>
                <label>Stabilized Other Income ($/yr)</label>
                <input id="stbOtherIncome" type="number" min="0" step="100" value="0"/>
              </div>
            </div>

            <div class="row">
              <div>
                <label>Stabilized Vacancy & Credit Loss (%)</label>
                <input id="stbVacPct" type="number" min="0" max="100" step="0.1" value="7.0"/>
              </div>
              <div>
                <label>Bad Debt Allowance (% of gross) (optional)</label>
                <input id="badDebtPct" type="number" min="0" max="10" step="0.1" value="0.0"/>
              </div>
            </div>

            <div class="row">
              <div>
                <label>Rent Growth (%/yr)</label>
                <input id="rentGrowth" type="number" min="-20" max="30" step="0.1" value="2.0"/>
              </div>
              <div>
                <label>Expense Growth (%/yr)</label>
                <input id="expGrowth" type="number" min="-20" max="30" step="0.1" value="3.0"/>
              </div>
            </div>

            <h3>Stabilized Expense Assumptions</h3>
            <div class="row">
              <div>
                <label>Stabilized Taxes ($/yr)</label>
                <input id="stbTaxes" type="number" min="0" step="100" value="0"/>
              </div>
              <div>
                <label>Stabilized Insurance ($/yr)</label>
                <input id="stbIns" type="number" min="0" step="100" value="0"/>
              </div>
            </div>

            <div class="row">
              <div>
                <label>Stabilized R&M ($/yr)</label>
                <input id="stbRepairs" type="number" min="0" step="100" value="0"/>
              </div>
              <div>
                <label>Stabilized Utilities ($/yr)</label>
                <input id="stbUtils" type="number" min="0" step="100" value="0"/>
              </div>
            </div>

            <div class="row">
              <div>
                <label>Stabilized Other OpEx ($/yr)</label>
                <input id="stbOtherOpex" type="number" min="0" step="100" value="0"/>
              </div>
              <div>
                <label>Replacement Reserves ($/yr)</label>
                <input id="stbRepl" type="number" min="0" step="100" value="0"/>
              </div>
            </div>

            <div class="row">
              <div>
                <label>CapEx Reserve ($/yr)</label>
                <input id="stbCapex" type="number" min="0" step="100" value="0"/>
              </div>
              <div>
                <label>Mgmt Fee (% of EGI)</label>
                <input id="stbMgmtPct" type="number" min="0" max="100" step="0.1" value="4.0"/>
              </div>
            </div>

            <div class="callout">
              <strong>Interpretation:</strong> Pro forma NOI must be explained. If it relies on “low vacancy + no reserves + minimal mgmt,” it is not institutional.
            </div>
          </div>

          <div>
            <h3>Exit & Reversion</h3>
            <div class="row">
              <div>
                <label>Exit Cap Rate (%)</label>
                <input id="exitCap" type="number" min="0" step="0.01" value="6.50"/>
              </div>
              <div>
                <label>Exit Cap Buffer (bps) (added to cap for conservative exit)</label>
                <input id="exitCapBuffer" type="number" min="0" step="25" value="50"/>
              </div>
            </div>

            <div class="row">
              <div>
                <label>Sales Costs (% of sale price)</label>
                <input id="saleCostPct" type="number" min="0" step="0.1" value="3.0"/>
              </div>
              <div>
                <label>Time‑to‑Exit (months)</label>
                <input id="timeToExit" type="number" min="0" step="1" value="12"/>
              </div>
            </div>

            <div class="row">
              <div>
                <label>Projection Horizon (years)</label>
                <input id="projYears" type="number" min="1" step="1" value="5"/>
              </div>
              <div>
                <label>Permanent Refi Rate (% annual) (takeout)</label>
                <input id="takeoutRate" type="number" min="0" step="0.01" value="7.00"/>
              </div>
            </div>

            <div class="row">
              <div>
                <label>Takeout Amortization (years)</label>
                <input id="takeoutAmort" type="number" min="1" step="1" value="30"/>
              </div>
              <div>
                <label>Takeout DSCR Requirement</label>
                <input id="takeoutDSCR" type="number" min="0" step="0.01" value="1.25"/>
              </div>
            </div>

            <div class="hr"></div>
            <h3>Pro Forma Outputs</h3>
            <div class="kpiGrid" id="kpiPF"></div>

            <div class="hr"></div>
            <h3>Year‑By‑Year Projection</h3>
            <div id="projWrap"></div>

            <div class="footerNote">
              Takeout feasibility is evaluated both by DSCR and by implied takeout LTV (based on market cap rate + conservative buffer).
            </div>
          </div>
        </div>
      </div>
    </section>

    <section class="page" id="p_construction">
      <div class="card">
        <h2>G. Construction / Value‑Add / Business Plan</h2>
        <p><strong>Purpose:</strong> Underwrite budget realism, schedule risk, and cost overrun protection. This is often where private credit losses originate (scope creep, delays, insufficient reserves).</p>

        <div class="grid2">
          <div>
            <h3>Scope & Schedule</h3>
            <div class="row">
              <div>
                <label>Scope Summary</label>
                <textarea id="scope" placeholder="Major work items, systems, interiors/exteriors, leasing scope, TI/LC..."></textarea>
              </div>
              <div>
                <label>Schedule Narrative</label>
                <textarea id="scheduleNotes" placeholder="Start date, milestones, critical path, seasonality, permitting dependencies..."></textarea>
              </div>
            </div>

            <div class="row">
              <div>
                <label>Hard Cost / SF or Unit ($)</label>
                <input id="hardPer" type="number" min="0" step="1" value="0"/>
              </div>
              <div>
                <label>Contingency Adequacy (Underwriter)</label>
                <select id="contAdeq">
                  <option>Adequate</option><option>Borderline</option><option>Inadequate</option><option>Unknown</option>
                </select>
              </div>
            </div>

            <div class="row">
              <div>
                <label>Contractor Experience (Underwriter)</label>
                <select id="gcExp">
                  <option>Strong</option><option>Moderate</option><option>Weak</option><option>Unknown</option>
                </select>
              </div>
              <div>
                <label>Owner‑Builder Risk</label>
                <select id="obRisk">
                  <option>Low</option><option>Moderate</option><option>High</option><option>Not Applicable</option>
                </select>
              </div>
            </div>

            <div class="callout">
              <strong>Controls that matter:</strong> third‑party budget review, GMP or fixed contract where possible, lender‑controlled contingency, and inspections with lien waivers.
            </div>
          </div>

          <div>
            <h3>Interest Carry & Reserve Adequacy</h3>
            <p class="small">This section estimates interest carry over the stabilization timeline (construction + lease‑up + buffer) and compares to reserves.</p>

            <div class="row">
              <div>
                <label>Stabilization Timeline (months)</label>
                <input id="stabMonths" type="number" min="0" step="1" value="0"/>
              </div>
              <div>
                <label>Carry Buffer (months)</label>
                <input id="carryBufferMo" type="number" min="0" step="1" value="3"/>
              </div>
            </div>

            <div class="row">
              <div>
                <label>Assumed Avg Utilization (% of loan)</label>
                <input id="avgUtilPct" type="number" min="0" max="100" step="1" value="80"/>
              </div>
              <div>
                <label>Operating Deficit During Lease‑Up ($/mo) (optional)</label>
                <input id="leaseupDef" type="number" min="0" step="100" value="0"/>
              </div>
            </div>

            <div class="kpiGrid" id="kpiCarry"></div>

            <div class="warnbox" id="carryWarn" style="display:none"></div>

            <div class="hr"></div>
            <h3>Draw Schedule (Simple)</h3>
            <p class="small">Add expected draws by month (optional). If not provided, the tool assumes even utilization.</p>
            <table class="table" id="drawTbl">
              <thead>
                <tr><th class="nowrap">Month</th><th class="right">Draw ($)</th><th>Milestone</th><th class="right"></th></tr>
              </thead>
              <tbody></tbody>
            </table>
            <div class="rowBtns">
              <button class="btn" id="addDraw">Add Draw Row</button>
              <button class="btn" id="evenDraw">Auto‑Even Draws</button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section class="page" id="p_sponsor">
      <div class="card">
        <h2>H. Sponsor / Guarantor Spread (Bank‑Level)</h2>
        <p><strong>Purpose:</strong> Evaluate guarantor strength, liquidity, contingent liabilities, and capacity to support the loan through stress. Private credit differs from banks in structure flexibility, but sponsor capacity still matters.</p>

        <div class="grid2">
          <div>
            <h3>Personal Financial Statement (Summary)</h3>
            <div class="row">
              <div>
                <label>Cash & Equivalents ($)</label>
                <input id="pfsCash" type="number" min="0" step="1000" value="0"/>
              </div>
              <div>
                <label>Marketable Securities ($)</label>
                <input id="pfsMarket" type="number" min="0" step="1000" value="0"/>
              </div>
            </div>

            <div class="row">
              <div>
                <label>Other Liquid (Retirement, etc.) ($)</label>
                <input id="pfsOtherLiq" type="number" min="0" step="1000" value="0"/>
              </div>
              <div>
                <label>Illiquid RE Equity ($)</label>
                <input id="pfsReEq" type="number" min="0" step="1000" value="0"/>
              </div>
            </div>

            <div class="row">
              <div>
                <label>Business Interests ($)</label>
                <input id="pfsBiz" type="number" min="0" step="1000" value="0"/>
              </div>
              <div>
                <label>Other Assets ($)</label>
                <input id="pfsOther" type="number" min="0" step="1000" value="0"/>
              </div>
            </div>

            <h3>Liabilities</h3>
            <div class="row">
              <div>
                <label>Total Liabilities ($)</label>
                <input id="pfsLiab" type="number" min="0" step="1000" value="0"/>
              </div>
              <div>
                <label>Contingent Liabilities ($) (PGs, lawsuits)</label>
                <input id="contLiab" type="number" min="0" step="1000" value="0"/>
              </div>
            </div>

            <div class="row">
              <div>
                <label>Liquidity Haircut (% applied to “liquid” assets)</label>
                <input id="liqHaircut" type="number" min="0" max="50" step="1" value="5"/>
              </div>
              <div>
                <label>RE Equity Haircut (% applied to illiquid RE)</label>
                <input id="reHaircut" type="number" min="0" max="80" step="5" value="25"/>
              </div>
            </div>

            <div class="callout">
              <strong>Conservatism:</strong> Apply haircuts. Liquidity on paper is not liquidity in a workout.
            </div>
          </div>

          <div>
            <h3>Income & Global Support</h3>
            <div class="row">
              <div>
                <label>Personal Income (stable) ($/yr)</label>
                <input id="persIncome" type="number" min="0" step="1000" value="0"/>
              </div>
              <div>
                <label>Personal Living Expenses ($/yr)</label>
                <input id="living" type="number" min="0" step="1000" value="0"/>
              </div>
            </div>

            <div class="row">
              <div>
                <label>Other Required Debt Pmts ($/yr) (non‑RE)</label>
                <input id="otherDebt" type="number" min="0" step="1000" value="0"/>
              </div>
              <div>
                <label>Other Income Volatility</label>
                <select id="incomeVol">
                  <option>Low</option><option>Moderate</option><option>High</option><option>Unknown</option>
                </select>
              </div>
            </div>

            <label>Sponsor Track Record (summary)</label>
            <textarea id="track" placeholder="Past projects, realized exits, construction experience, litigation, bankruptcies, fraud checks..."></textarea>

            <label>Concentration Risk Notes</label>
            <textarea id="conc" placeholder="Tenant, geography, property type concentration; reliance on one revenue stream..."></textarea>

            <div class="hr"></div>
            <h3>Sponsor KPIs (Auto)</h3>
            <div class="kpiGrid" id="kpiSponsor"></div>

            <div class="warnbox" id="sponsorWarn" style="display:none"></div>
          </div>
        </div>
      </div>
    </section>

    <section class="page" id="p_global">
      <div class="card">
        <h2>I. Global Cash Flow (Portfolio & Businesses)</h2>
        <p><strong>Purpose:</strong> Calculate global DSCR and identify liquidity burn sensitivity. This helps determine whether the sponsor can carry a project through delays, vacancy shocks, or rate shocks.</p>

        <div class="grid2">
          <div>
            <h3>Portfolio Summary Inputs</h3>
            <div class="row">
              <div>
                <label>Global NOI / Cash Flow Available ($/yr)</label>
                <input id="globalNoi" type="number" min="0" step="1000" value="0"/>
              </div>
              <div>
                <label>Global Debt Service ($/yr)</label>
                <input id="globalDebtSvc" type="number" min="0" step="1000" value="0"/>
              </div>
            </div>

            <div class="row">
              <div>
                <label>Portfolio Vacancy Sensitivity (% pts)</label>
                <input id="globVacSens" type="number" min="0" max="50" step="0.5" value="5"/>
              </div>
              <div>
                <label>Portfolio Rate Shock (bps)</label>
                <input id="globRateBps" type="number" min="0" max="1000" step="25" value="200"/>
              </div>
            </div>

            <div class="callout">
              <strong>Interpretation:</strong> A strong property DSCR is not sufficient if the sponsor’s global position is weak and relies on constant refis or thin cash flow.
            </div>

            <div class="hr"></div>

            <h3>Portfolio Detail (Optional Table)</h3>
            <p class="small">Add key properties to compute a “bottom-up” global DSCR. If you use this, keep it conservative and tie to real statements.</p>
            <table class="table" id="globTbl">
              <thead>
                <tr>
                  <th>Property</th>
                  <th class="right">NOI ($/yr)</th>
                  <th class="right">Debt Svc ($/yr)</th>
                  <th>Notes</th>
                  <th class="right"></th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
            <div class="rowBtns">
              <button class="btn" id="addGlob">Add Property</button>
              <button class="btn" id="sumGlob">Set Global NOI/Debt from Table</button>
            </div>
          </div>

          <div>
            <h3>Global Outputs & Sensitivity</h3>
            <div class="kpiGrid" id="kpiGlobal"></div>

            <div class="hr"></div>
            <h3>Sensitivity (Simple)</h3>
            <div id="globSens"></div>

            <div class="footerNote">
              If global DSCR is weak, tighten the transaction: lower leverage, larger reserves, faster amortization, or require additional collateral.
            </div>
          </div>
        </div>
      </div>
    </section>

    <section class="page" id="p_stress">
      <div class="card">
        <h2>J. Stress Testing & Downside Scenarios</h2>
        <p><strong>Purpose:</strong> Explicitly quantify what goes wrong, and show whether the loan can survive (or what the loss severity looks like). Private credit should price for downside but structure for survivability.</p>

        <div class="grid2">
          <div>
            <h3>Downside Inputs</h3>
            <div class="row">
              <div>
                <label>Rent Decline (% of stabilized rent)</label>
                <input id="stRentDown" type="number" min="0" max="60" step="0.5" value="10"/>
              </div>
              <div>
                <label>Vacancy Increase (absolute % pts)</label>
                <input id="stVacUp" type="number" min="0" max="40" step="0.5" value="5"/>
              </div>
            </div>
            <div class="row">
              <div>
                <label>Exit Cap Expansion (bps)</label>
                <input id="stCapBps" type="number" min="0" max="500" step="25" value="75"/>
              </div>
              <div>
                <label>Rate Shock (bps)</label>
                <input id="stRateBps" type="number" min="0" max="1000" step="25" value="200"/>
              </div>
            </div>
            <div class="row">
              <div>
                <label>Cost Overrun (% of hard costs)</label>
                <input id="stCostOver" type="number" min="0" max="100" step="1" value="10"/>
              </div>
              <div>
                <label>Lease‑Up / Execution Delay (months)</label>
                <input id="stDelayMo" type="number" min="0" max="36" step="1" value="3"/>
              </div>
            </div>

            <h3>Forced Sale Analysis</h3>
            <div class="row">
              <div>
                <label>Forced Sale Discount (% vs as‑is)</label>
                <input id="forcedDisc" type="number" min="0" max="60" step="1" value="15"/>
              </div>
              <div>
                <label>Workout Costs (% of sale)</label>
                <input id="workoutCost" type="number" min="0" max="20" step="0.5" value="6"/>
              </div>
            </div>

            <div class="callout">
              <strong>Interpretation:</strong> Stress tests should reflect plausible downside (not catastrophe). If plausible downside implies principal loss, restructure.
            </div>
          </div>

          <div>
            <h3>Stress Outputs</h3>
            <div class="kpiGrid" id="kpiStress"></div>

            <div class="hr"></div>
            <h3>Mini Sensitivity Matrix (DSCR vs Cap Rate)</h3>
            <div id="sensMatrix"></div>

            <div class="hr"></div>
            <h3>Downside Narrative (Auto Draft)</h3>
            <div class="small" id="stressNarr"></div>
          </div>
        </div>
      </div>
    </section>

    <section class="page" id="p_legal">
      <div class="card">
        <h2>K. Collateral & Legal Review</h2>
        <p><strong>Purpose:</strong> Track third‑party diligence and “deal killers” (title, zoning, environmental, insurance). Credit approval should be conditioned on satisfactory diligence.</p>

        <div class="grid2">
          <div>
            <h3>Title / Survey / Liens</h3>
            <div class="row">
              <div>
                <label>Title Commitment Received?</label>
                <select id="titleRecv">
                  <option>No</option><option>Yes</option>
                </select>
              </div>
              <div>
                <label>Title Exceptions Acceptable?</label>
                <select id="titleOk">
                  <option>Unknown</option><option>Yes</option><option>No</option>
                </select>
              </div>
            </div>
            <div class="row">
              <div>
                <label>Survey Received?</label>
                <select id="surveyRecv"><option>No</option><option>Yes</option></select>
              </div>
              <div>
                <label>Mechanics Lien Risk</label>
                <select id="mlRisk"><option>Low</option><option>Moderate</option><option>High</option><option>Unknown</option></select>
              </div>
            </div>

            <label>Title / Legal Notes</label>
            <textarea id="titleNotes" placeholder="Lien issues, easements, access, encroachments, HOA, litigation, etc."></textarea>

            <h3>Zoning / Entitlements</h3>
            <div class="row">
              <div>
                <label>Zoning Verified?</label>
                <select id="zoning"><option>Unknown</option><option>Yes</option><option>No</option></select>
              </div>
              <div>
                <label>Use Conforms?</label>
                <select id="conforming"><option>Unknown</option><option>Yes</option><option>No</option></select>
              </div>
            </div>
            <label>Zoning Notes</label>
            <textarea id="zoningNotes"></textarea>
          </div>

          <div>
            <h3>Environmental / Insurance / Appraisal</h3>
            <div class="row">
              <div>
                <label>Phase I ESA Required?</label>
                <select id="phaseReq"><option>Unknown</option><option>Yes</option><option>No</option></select>
              </div>
              <div>
                <label>Phase I Result</label>
                <select id="phaseRes"><option>Pending</option><option>Clean</option><option>RECs Identified</option><option>Not Applicable</option></select>
              </div>
            </div>
            <div class="row">
              <div>
                <label>Insurance Bound?</label>
                <select id="insBound"><option>No</option><option>Yes</option></select>
              </div>
              <div>
                <label>Coverage Adequate?</label>
                <select id="insOk"><option>Unknown</option><option>Yes</option><option>No</option></select>
              </div>
            </div>
            <div class="row">
              <div>
                <label>Appraisal Reviewed?</label>
                <select id="appRev"><option>No</option><option>Yes</option></select>
              </div>
              <div>
                <label>Appraisal Concerns?</label>
                <select id="appConc"><option>No</option><option>Yes</option><option>Unknown</option></select>
              </div>
            </div>

            <label>Diligence / Legal Conditions Draft</label>
            <textarea id="legalConds" placeholder="List specific conditions: title endorsements, Phase I, zoning letter, ALTA survey, insurance requirements, etc."></textarea>

            <div class="hr"></div>
            <h3>Diligence Readiness</h3>
            <div class="kpiGrid" id="kpiDiligence"></div>

            <div class="warnbox" id="dilWarn" style="display:none"></div>
          </div>
        </div>
      </div>
    </section>

    <section class="page" id="p_rating">
      <div class="card">
        <h2>L. Risk Rating & Credit Decision Framework</h2>
        <p><strong>Purpose:</strong> Produce an internal rating that is repeatable, auditable, and linked to pricing/structure expectations. Adjust weights to match your internal policy.</p>

        <div class="grid2">
          <div>
            <h3>Quantitative Weighting</h3>
            <div class="row">
              <div>
                <label>Weight: Leverage (LTV/LTC)</label>
                <input id="wLev" type="number" min="0" max="100" step="1" value="30"/>
              </div>
              <div>
                <label>Weight: Cash Flow (DSCR/DY)</label>
                <input id="wCF" type="number" min="0" max="100" step="1" value="30"/>
              </div>
            </div>
            <div class="row">
              <div>
                <label>Weight: Sponsor Strength</label>
                <input id="wSp" type="number" min="0" max="100" step="1" value="25"/>
              </div>
              <div>
                <label>Weight: Collateral Liquidity</label>
                <input id="wCol" type="number" min="0" max="100" step="1" value="15"/>
              </div>
            </div>

            <div class="callout">
              <strong>Practice:</strong> Risk rating should be stable over time and comparable across deals. Avoid “custom scoring” that only supports approval.
            </div>

            <div class="hr"></div>
            <h3>Risk-Based Pricing Guidance</h3>
            <p class="small">This is advisory only. In production, link to your pricing matrix. Here we provide a baseline spread suggestion.</p>
            <div class="kpiGrid" id="kpiPricingGuide"></div>
          </div>

          <div>
            <h3>Computed Rating</h3>
            <div class="kpiGrid" id="kpiRating"></div>

            <div class="hr"></div>
            <h3>Committee Summary (Auto Draft)</h3>
            <div class="small" id="ratingNarr"></div>

            <div class="footerNote">
              Ratings should be supported by exhibits: appraisal, rent roll, T‑12, sponsor PFS, background check, and budget.
            </div>
          </div>
        </div>
      </div>
    </section>

    <section class="page" id="p_conditions">
      <div class="card">
        <h2>M. Conditions, Covenants & Monitoring</h2>
        <p><strong>Purpose:</strong> Translate underwriting findings into enforceable conditions and ongoing monitoring. The best credit decisions are “operationalized” with triggers and reporting cadence.</p>

        <div class="grid2">
          <div>
            <h3>Pre‑Funding Conditions (Core)</h3>
            <label>Conditions (editable)</label>
            <textarea id="conds" placeholder="Auto-populated in outputs; edit to match the deal."></textarea>

            <h3>Ongoing Reporting</h3>
            <div class="row">
              <div>
                <label>Monthly Rent Roll?</label>
                <select id="monRR"><option>Yes</option><option>No</option></select>
              </div>
              <div>
                <label>Quarterly Financials?</label>
                <select id="qFin"><option>Yes</option><option>No</option></select>
              </div>
            </div>

            <div class="row">
              <div>
                <label>Annual Borrower Financials?</label>
                <select id="annFin"><option>Yes</option><option>No</option></select>
              </div>
              <div>
                <label>Construction Reporting (if applicable)</label>
                <select id="constRpt"><option>Not Applicable</option><option>Monthly</option><option>Per Draw</option></select>
              </div>
            </div>

            <div class="callout">
              <strong>Principle:</strong> If a risk is material, it should map to a covenant, reserve, control, or reporting requirement.
            </div>
          </div>

          <div>
            <h3>Covenants & Triggers</h3>
            <div class="row">
              <div>
                <label>Minimum DSCR Covenant</label>
                <input id="covDSCR" type="number" min="0" step="0.01" value="1.10"/>
              </div>
              <div>
                <label>Max LTV Covenant (%)</label>
                <input id="covLTV" type="number" min="0" step="0.1" value="85.0"/>
              </div>
            </div>

            <div class="row">
              <div>
                <label>Cash Sweep Trigger DSCR</label>
                <input id="sweepDSCR" type="number" min="0" step="0.01" value="1.00"/>
              </div>
              <div>
                <label>Reserve Top‑Up Trigger</label>
                <select id="topup"><option>Yes</option><option>No</option></select>
              </div>
            </div>

            <label>Early Warning Indicators</label>
            <textarea id="ewi" placeholder="Examples: DSCR deterioration, occupancy drop, budget variance, lien notices, tax delinquency, sponsor liquidity decline..."></textarea>

            <div class="hr"></div>
            <h3>Monitoring Summary (Auto)</h3>
            <div class="small" id="monNarr"></div>
          </div>
        </div>
      </div>
    </section>

    <section class="page" id="p_outputs">
      <div class="card">
        <h2>N. Outputs (Executive Summary & Credit Memo)</h2>
        <p><strong>Purpose:</strong> Produce committee-ready outputs: one-page summary, key metrics, risk/mitigants, and a structured memo. All outputs are derived from your inputs.</p>

        <div class="grid2">
          <div>
            <h3>1‑Page Executive Credit Summary</h3>
            <div class="kpiGrid" id="kpiExec"></div>

            <div class="hr"></div>
            <div class="grid2">
              <div>
                <h3>Key Risks</h3>
                <ul id="outRisks" class="small"></ul>
              </div>
              <div>
                <h3>Mitigants</h3>
                <ul id="outMitigants" class="small"></ul>
              </div>
            </div>

            <div class="hr"></div>
            <h3>Exit Strategy</h3>
            <div class="small" id="outExit"></div>

            <div class="hr"></div>
            <h3>Conditions (Draft)</h3>
            <ul id="outConds" class="small"></ul>
          </div>

          <div>
            <h3>Full Credit Memo (Structured)</h3>
            <div id="memo"></div>

            <div class="printOnly" style="margin-top:14px">
              <div class="small">Printed summary generated from stored inputs. Attach exhibits: rent roll, T‑12, appraisal/BPO, title, insurance, budget, sponsor PFS, and exit comps.</div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section class="page" id="p_feedback">
      <div class="card">
        <h2>O. Underwriter Feedback & Improvement Recommendations</h2>
        <p><strong>Purpose:</strong> Provide built-in critiques of your underwriting file quality and suggest how to strengthen it (structure, diligence, assumptions).</p>

        <div class="grid2">
          <div>
            <h3>File Quality Flags (Auto)</h3>
            <div id="qualityFlags"></div>

            <div class="hr"></div>
            <h3>How to Make This Better (Design Notes)</h3>
            <div class="callout">
              <ul>
                <li><strong>Add document uploads:</strong> In production, add a backend for storing rent rolls, T‑12 PDFs, appraisal, and insurance binders, and tie each to a checklist item.</li>
                <li><strong>Expand global cash flow:</strong> Add a full schedule of real estate owned (SREO) with liens, rates, maturities, and DSCR per asset.</li>
                <li><strong>Normalize automatically:</strong> Add “market vacancy” by asset/submarket and capex/reserve benchmarks by property type.</li>
                <li><strong>Facility compliance:</strong> Add warehouse line covenants (max LTV, min DY, seasoning rules) and flag exceptions.</li>
                <li><strong>Decision log:</strong> Add a section capturing committee questions and final conditions to create a permanent audit trail.</li>
                <li><strong>Cash management engine:</strong> Model lockbox, waterfall, and triggers, and generate covenant tests automatically.</li>
              </ul>
            </div>
          </div>

          <div>
            <h3>Underwriter Notes</h3>
            <label>Strengths</label>
            <textarea id="uwStrengths" placeholder="List primary strengths in bank-style terms (collateral quality, liquidity, exit certainty, low leverage, etc.)."></textarea>

            <label>Weaknesses</label>
            <textarea id="uwWeaknesses" placeholder="List primary weaknesses (thin DSCR, execution risk, shallow market, sponsor liquidity, etc.)."></textarea>

            <label>Key Questions for Sponsor / Borrower</label>
            <textarea id="uwQuestions" placeholder="What needs to be answered before approval/closing?"></textarea>

            <label>Committee Talking Points</label>
            <textarea id="uwTalking" placeholder="Anticipate objections and preempt with facts/mitigants."></textarea>
          </div>
        </div>
      </div>
    </section>

  </main>
</div>

<script>
/* =========================================================
   Utilities
========================================================= */
const $ = (id)=>document.getElementById(id);
const qsa = (sel)=>Array.from(document.querySelectorAll(sel));
const safeNum = (v)=> Number(v||0);
const clamp = (x,min,max)=>Math.min(max,Math.max(min,x));
const safeDiv = (a,b)=> (safeNum(b)===0? 0 : safeNum(a)/safeNum(b));
const fmt$ = (n)=> {
  n=safeNum(n);
  const sign = n<0 ? "-" : "";
  n=Math.abs(n);
  return sign + n.toLocaleString(undefined,{style:"currency",currency:"USD",maximumFractionDigits:0});
};
const fmtPct = (x,dp=2)=> (safeNum(x)).toFixed(dp) + "%";
const fmtX = (x,dp=2)=> (safeNum(x)).toFixed(dp) + "×";
const todayISO = ()=> new Date().toISOString().slice(0,10);
function escapeHtml(s){ return String(s||"").replace(/[&<>"]/g, c=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;" }[c])); }

function pmt(ratePerPeriod, nper, pv){
  const r=ratePerPeriod;
  if(nper<=0) return 0;
  if(Math.abs(r)<1e-9) return pv/nper;
  return (pv*r)/(1-Math.pow(1+r,-nper));
}
function annDebtService(loanAmt, noteRatePct, amortYears){
  const r=(noteRatePct/100)/12;
  const n=Math.max(1, Math.round(amortYears*12));
  return pmt(r,n,loanAmt)*12;
}
function annInterestOnly(loanAmt, noteRatePct){
  return loanAmt*(noteRatePct/100);
}
function tagFor(val, goodFn, warnFn){
  if(goodFn(val)) return {cls:"good", label:"Good"};
  if(warnFn(val)) return {cls:"warn", label:"Watch"};
  return {cls:"bad", label:"Weak"};
}
function kpiCard(title, value, tag, note=""){
  return `
    <div class="kpi">
      <div class="t">${escapeHtml(title)}</div>
      <div class="v">${value}</div>
      <div class="s">
        <span class="tag ${tag.cls}">
          <span class="dot ${tag.cls}"></span>${tag.label}${note?` · <span class="muted">${escapeHtml(note)}</span>`:""}
        </span>
      </div>
    </div>`;
}
function productLabel(p){
  const map={
    bridge:"Bridge (Transitional)",
    fixflip:"Fix‑and‑Flip",
    construction:"Ground‑Up Construction",
    commercial_bridge:"Commercial Bridge",
    land:"Land Acquisition",
    second_lien:"Second Lien / Mezz",
    dscr:"DSCR / Investment Property"
  };
  return map[p]||p;
}

/* =========================================================
   Product Defaults (you can tune)
========================================================= */
const productDefaults = {
  bridge:            { termMonths:12, ioMonths:12, noteRate:12.0, amortYears:30, origPoints:2.0, lienPos:"1st" },
  fixflip:           { termMonths:12, ioMonths:12, noteRate:12.5, amortYears:30, origPoints:2.0, lienPos:"1st" },
  construction:      { termMonths:18, ioMonths:18, noteRate:12.5, amortYears:30, origPoints:2.0, lienPos:"1st" },
  commercial_bridge: { termMonths:18, ioMonths:18, noteRate:11.5, amortYears:30, origPoints:1.5, lienPos:"1st" },
  land:              { termMonths:18, ioMonths:18, noteRate:12.0, amortYears:30, origPoints:2.0, lienPos:"1st" },
  second_lien:       { termMonths:12, ioMonths:12, noteRate:14.0, amortYears:30, origPoints:2.5, lienPos:"2nd" },
  dscr:              { termMonths:60, ioMonths:0,  noteRate:8.5,  amortYears:30, origPoints:1.0, lienPos:"1st" }
};
function applyDefaults(prod){
  const d = productDefaults[prod]; if(!d) return;
  $("termMonths").value = d.termMonths;
  $("ioMonths").value = d.ioMonths;
  $("noteRate").value = d.noteRate.toFixed(2);
  $("amortYears").value = d.amortYears;
  $("origPoints").value = d.origPoints.toFixed(2);
  $("lienPos").value = d.lienPos;
}

/* =========================================================
   Dynamic Tables (Rent Roll, Global, Draws)
========================================================= */
let rentRoll = [];
let globProps = [];
let draws = [];

function rrRow(i, r){
  return `<tr>
    <td><input data-rr="tenant" data-i="${i}" value="${escapeHtml(r.tenant||"")}" placeholder="Tenant/Unit"/></td>
    <td class="right"><input data-rr="rent" data-i="${i}" type="number" step="10" value="${safeNum(r.rent||0)}"/></td>
    <td class="right"><input data-rr="exp" data-i="${i}" value="${escapeHtml(r.exp||"")}" placeholder="MM/YY"/></td>
    <td><input data-rr="notes" data-i="${i}" value="${escapeHtml(r.notes||"")}" placeholder="Notes"/></td>
    <td class="right"><button class="btn" onclick="delRR(${i})">Del</button></td>
  </tr>`;
}
function renderRR(){
  const tb = $("rentRollTbl").querySelector("tbody");
  tb.innerHTML = rentRoll.map((r,i)=>rrRow(i,r)).join("") || `<tr><td colspan="5" class="small">No rows yet.</td></tr>`;
  qsa("[data-rr]").forEach(el=>{
    el.addEventListener("input", ()=>{
      const i=Number(el.dataset.i), k=el.dataset.rr;
      rentRoll[i][k] = (k==="rent")? safeNum(el.value): el.value;
      persistDraft();
    });
  });
}
function delRR(i){ rentRoll.splice(i,1); renderRR(); calc(); }
function addRR(){
  rentRoll.push({tenant:"",rent:0,exp:"",notes:""});
  renderRR();
}
function sumRR(){
  const totalMonthly = rentRoll.reduce((s,r)=>s+safeNum(r.rent),0);
  $("grossRent").value = Math.round(totalMonthly*12);
  toast("Gross Scheduled Rent updated from rent roll.");
  calc();
}

function globRow(i, r){
  return `<tr>
    <td><input data-g="name" data-i="${i}" value="${escapeHtml(r.name||"")}" placeholder="Property"/></td>
    <td class="right"><input data-g="noi" data-i="${i}" type="number" step="100" value="${safeNum(r.noi||0)}"/></td>
    <td class="right"><input data-g="ds" data-i="${i}" type="number" step="100" value="${safeNum(r.ds||0)}"/></td>
    <td><input data-g="notes" data-i="${i}" value="${escapeHtml(r.notes||"")}" placeholder="Notes"/></td>
    <td class="right"><button class="btn" onclick="delGlob(${i})">Del</button></td>
  </tr>`;
}
function renderGlob(){
  const tb = $("globTbl").querySelector("tbody");
  tb.innerHTML = globProps.map((r,i)=>globRow(i,r)).join("") || `<tr><td colspan="5" class="small">No properties yet.</td></tr>`;
  qsa("[data-g]").forEach(el=>{
    el.addEventListener("input", ()=>{
      const i=Number(el.dataset.i), k=el.dataset.g;
      globProps[i][k] = (k==="noi"||k==="ds")? safeNum(el.value): el.value;
      persistDraft();
    });
  });
}
function delGlob(i){ globProps.splice(i,1); renderGlob(); calc(); }
function addGlob(){
  globProps.push({name:"",noi:0,ds:0,notes:""});
  renderGlob();
}
function sumGlob(){
  const noi = globProps.reduce((s,r)=>s+safeNum(r.noi),0);
  const ds  = globProps.reduce((s,r)=>s+safeNum(r.ds),0);
  $("globalNoi").value = Math.round(noi);
  $("globalDebtSvc").value = Math.round(ds);
  toast("Global NOI / Debt Service set from table.");
  calc();
}

function drawRow(i, r){
  return `<tr>
    <td class="nowrap"><input data-d="mo" data-i="${i}" type="number" min="1" step="1" value="${safeNum(r.mo||1)}"/></td>
    <td class="right"><input data-d="amt" data-i="${i}" type="number" step="1000" value="${safeNum(r.amt||0)}"/></td>
    <td><input data-d="ms" data-i="${i}" value="${escapeHtml(r.ms||"")}" placeholder="Milestone"/></td>
    <td class="right"><button class="btn" onclick="delDraw(${i})">Del</button></td>
  </tr>`;
}
function renderDraws(){
  const tb = $("drawTbl").querySelector("tbody");
  tb.innerHTML = draws.map((r,i)=>drawRow(i,r)).join("") || `<tr><td colspan="4" class="small">No draw rows yet.</td></tr>`;
  qsa("[data-d]").forEach(el=>{
    el.addEventListener("input", ()=>{
      const i=Number(el.dataset.i), k=el.dataset.d;
      draws[i][k] = (k==="amt"||k==="mo")? safeNum(el.value): el.value;
      persistDraft();
    });
  });
}
function delDraw(i){ draws.splice(i,1); renderDraws(); calc(); }
function addDraw(){ draws.push({mo:1, amt:0, ms:""}); renderDraws(); }
function evenDraw(){
  // Auto-even draws across constMonths (or stabMonths if defined)
  const loanAmt = safeNum($("loanAmount").value);
  const months = Math.max(1, safeNum($("constMonths").value||0) || safeNum($("stabMonths").value||0) || 6);
  draws = [];
  const per = loanAmt / months;
  for(let m=1;m<=months;m++) draws.push({mo:m, amt:Math.round(per/1000)*1000, ms:""});
  renderDraws();
  toast("Even draw schedule generated.");
  calc();
}

/* =========================================================
   Persistence: localStorage + JSON
========================================================= */
const STORAGE_KEY="uw_tool_v2";
function collectState(){
  const ids = qsa("input,select,textarea").map(el=>el.id).filter(Boolean);
  const data={}; ids.forEach(id=>{ data[id] = $(id).value; });
  data.__tables = { rentRoll, globProps, draws };
  return data;
}
function applyState(data){
  if(!data) return;
  Object.keys(data).forEach(k=>{
    if(k==="__tables") return;
    const el=$(k);
    if(el) el.value = data[k];
  });
  if(data.__tables){
    rentRoll = data.__tables.rentRoll || [];
    globProps = data.__tables.globProps || [];
    draws = data.__tables.draws || [];
    renderRR(); renderGlob(); renderDraws();
  }
}
function persistDraft(){
  try{ localStorage.setItem(STORAGE_KEY+"_draft", JSON.stringify({ts:Date.now(), data:collectState()})); }catch(e){}
}
function save(){
  localStorage.setItem(STORAGE_KEY, JSON.stringify({ts:Date.now(), data:collectState()}));
  toast("Saved.");
}
function load(){
  const raw = localStorage.getItem(STORAGE_KEY) || localStorage.getItem(STORAGE_KEY+"_draft");
  if(!raw) return false;
  try{
    const payload=JSON.parse(raw);
    applyState(payload.data||{});
    return true;
  }catch(e){ return false; }
}
function exportJSON(){
  const payload={version:"uw_tool_v2", exportedAt:new Date().toISOString(), data:collectState()};
  const blob=new Blob([JSON.stringify(payload,null,2)],{type:"application/json"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  const nm=($("dealName").value||"underwriting").replace(/[^a-z0-9]+/gi,"_").toLowerCase();
  a.href=url; a.download=nm+"_uw_v2.json";
  document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}
function importJSON(){
  const inp=document.createElement("input");
  inp.type="file"; inp.accept="application/json";
  inp.onchange=async ()=>{
    const f=inp.files[0]; if(!f) return;
    const txt=await f.text();
    try{
      const payload=JSON.parse(txt);
      applyState(payload.data||payload);
      toast("Imported.");
      calc();
    }catch(e){ alert("Invalid JSON."); }
  };
  inp.click();
}
function clearAll(){
  if(!confirm("Clear all inputs and local saved state?")) return;
  localStorage.removeItem(STORAGE_KEY);
  localStorage.removeItem(STORAGE_KEY+"_draft");
  qsa("input,select,textarea").forEach(el=>{
    if(el.type==="number") el.value = 0;
    else if(el.type==="date") el.value = "";
    else if(el.tagName==="SELECT") el.selectedIndex = 0;
    else el.value = "";
  });
  rentRoll=[]; globProps=[]; draws=[];
  renderRR(); renderGlob(); renderDraws();
  // restore some sane defaults
  $("uwDate").value = todayISO();
  $("cofPctFunded").value = 80;
  $("cofRate").value = 8.00;
  $("policyMinDSCR").value = 1.20;
  $("targetROA").value = 10.0;
  $("targetCoC").value = 18.0;
  applyDefaults($("loanProduct").value);
  toast("Cleared.");
  calc();
}

/* =========================================================
   UI helpers
========================================================= */
function toast(msg){
  const t=document.createElement("div");
  t.textContent=msg;
  t.style.cssText="position:fixed;bottom:16px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,.78);border:1px solid rgba(255,255,255,.18);color:white;padding:10px 12px;border-radius:12px;font-size:12px;z-index:9999";
  document.body.appendChild(t);
  setTimeout(()=>t.remove(), 1300);
}
function showPage(id){
  qsa(".page").forEach(p=>p.classList.remove("active"));
  $(id).classList.add("active");
  qsa("#nav button").forEach(b=>{
    b.classList.toggle("active", b.dataset.page===id);
  });
  window.scrollTo({top:0, behavior:"instant"});
}

/* =========================================================
   Core Calculations
========================================================= */
let last = {}; // store last calc outputs for memo/exports
function calc(){
  // Deal header
  const deal = $("dealName").value.trim() || "—";
  const prod = $("loanProduct").value;
  $("hdrDeal").textContent = deal;
  $("hdrProd").textContent = productLabel(prod);

  // Ensure source loan default mirrors loan amount
  if(safeNum($("srcLoan").value)===0 && safeNum($("loanAmount").value)>0){
    $("srcLoan").value = $("loanAmount").value;
  }

  // Pull core inputs
  const loanAmt = safeNum($("loanAmount").value);
  const termMo = Math.max(1, safeNum($("termMonths").value));
  const ioMo = safeNum($("ioMonths").value);
  const noteRate = safeNum($("noteRate").value);
  const amortY = Math.max(1, safeNum($("amortYears").value));
  const points = safeNum($("origPoints").value);
  const otherFees = safeNum($("otherFees").value);
  const exitFee = safeNum($("exitFee").value);
  const cof = safeNum($("cofRate").value);
  const cofPct = safeNum($("cofPctFunded").value)/100;

  const lienPos = $("lienPos").value;
  const seniorAhead = safeNum($("seniorAhead").value);

  // Values
  const asIs = safeNum($("asIsValue").value);
  const arv = safeNum($("arvValue").value) || asIs;
  const purchase = safeNum($("purchasePrice").value);

  // Uses
  const borClosing = safeNum($("borClosing").value);
  const rehab = safeNum($("rehabBudget").value);
  const soft = safeNum($("softCosts").value);
  const contPct = safeNum($("contPct").value)/100;
  const contingency = rehab * contPct;
  const estCarry = safeNum($("estCarry").value);
  const leasingCosts = safeNum($("leasingCosts").value);
  const totalUsesOverride = safeNum($("totalUses").value);
  const totalUses = totalUsesOverride>0 ? totalUsesOverride : (purchase+borClosing+rehab+soft+contingency+estCarry+leasingCosts);
  const loanSrc = safeNum($("srcLoan").value) || loanAmt;
  const equity = safeNum($("sponsorEquity").value);
  const otherFin = safeNum($("otherFin").value);
  const sources = loanSrc + equity + otherFin;
  const gap = sources - totalUses;

  // Historical Ops
  const grossRent = safeNum($("grossRent").value);
  const otherInc = safeNum($("otherIncome").value);
  const vacPct = safeNum($("vacPct").value)/100;
  const mgmtPct = safeNum($("mgmtPct").value)/100;

  const taxes = safeNum($("taxes").value);
  const ins = safeNum($("insurance").value);
  const repairs = safeNum($("repairs").value);
  const utils = safeNum($("utilities").value);
  const payroll = safeNum($("payroll").value);
  const otherOpex = safeNum($("otherOpex").value);
  const repl = safeNum($("replReserves").value);
  const normAdj = safeNum($("normAdj").value);

  const grossIncome = grossRent + otherInc;
  const vacLoss = grossIncome * vacPct;
  const egi = grossIncome - vacLoss;
  const mgmt = egi * mgmtPct;
  const opEx = taxes + ins + repairs + utils + payroll + otherOpex + mgmt + repl + Math.max(0,normAdj);
  const noi = egi - opEx;

  // Pro Forma
  const stbGrossRent = safeNum($("stbGrossRent").value);
  const stbOtherIncome = safeNum($("stbOtherIncome").value);
  const stbVacPct = safeNum($("stbVacPct").value)/100;
  const badDebtPct = safeNum($("badDebtPct").value)/100;
  const rentG = safeNum($("rentGrowth").value)/100;
  const expG = safeNum($("expGrowth").value)/100;

  const stbTaxes = safeNum($("stbTaxes").value) || taxes;
  const stbIns = safeNum($("stbIns").value) || ins;
  const stbRep = safeNum($("stbRepairs").value) || repairs;
  const stbUtl = safeNum($("stbUtils").value) || utils;
  const stbOther = safeNum($("stbOtherOpex").value) || (payroll + otherOpex);
  const stbRepl = safeNum($("stbRepl").value) || repl;
  const stbCapex = safeNum($("stbCapex").value);
  const stbMgmtPct = safeNum($("stbMgmtPct").value)/100;

  const stbGI = stbGrossRent + stbOtherIncome;
  const stbVacLoss = stbGI * stbVacPct;
  const stbBadDebt = stbGI * badDebtPct;
  const stbEGI = stbGI - stbVacLoss - stbBadDebt;
  const stbMgmt = stbEGI * stbMgmtPct;
  const stbOpEx = stbTaxes + stbIns + stbRep + stbUtl + stbOther + stbMgmt + stbRepl + stbCapex;
  const stbNOI = stbEGI - stbOpEx;

  // Debt service (current loan)
  const annIO = annInterestOnly(loanAmt, noteRate);
  const annAm = annDebtService(loanAmt, noteRate, amortY);
  const dsAnnual = (prod==="dscr" && ioMo===0) ? annAm : (ioMo>=termMo ? annIO : annAm);

  // Ratios
  const ltv = safeDiv(loanAmt, asIs)*100;
  const ltvStb = safeDiv(loanAmt, arv)*100;
  const totalDebt = loanAmt + (lienPos!=="1st" ? seniorAhead : 0);
  const cltv = safeDiv(totalDebt, asIs)*100;
  const cltvStb = safeDiv(totalDebt, arv)*100;
  const ltc = safeDiv(loanAmt, totalUses)*100;

  const dscrHist = safeDiv(noi, dsAnnual);
  const dscrStb = safeDiv(stbNOI, dsAnnual);

  const dyHist = safeDiv(noi, loanAmt)*100;
  const dyStb = safeDiv(stbNOI, loanAmt)*100;

  const breakeven = safeDiv((opEx + dsAnnual), grossIncome)*100;

  // Exit / takeout
  const exitCap = safeNum($("exitCap").value)/100;
  const capBuf = safeNum($("exitCapBuffer").value)/10000;
  const exitCapCons = exitCap + capBuf;
  const saleCostPct = safeNum($("saleCostPct").value)/100;
  const projYears = Math.max(1, Math.round(safeNum($("projYears").value)));
  const takeoutRate = safeNum($("takeoutRate").value);
  const takeoutAmort = Math.max(1, safeNum($("takeoutAmort").value));
  const takeoutDSCR = safeNum($("takeoutDSCR").value);

  // Projections
  let proj = [];
  let yRent = stbGrossRent;
  let yOtherInc = stbOtherIncome;
  let yOpEx = stbOpEx;
  for(let y=1;y<=projYears;y++){
    if(y>1){ yRent *= (1+rentG); yOtherInc *= (1+rentG*0.5); yOpEx *= (1+expG); }
    const yGI = yRent + yOtherInc;
    const yEGI = yGI * (1 - stbVacPct - badDebtPct);
    const yNOI = yEGI - yOpEx;
    proj.push({year:y, gross:yGI, egi:yEGI, opex:yOpEx, noi:yNOI, ds:dsAnnual, dscr:safeDiv(yNOI, dsAnnual)});
  }
  const exitNOI = proj.length ? proj[proj.length-1].noi : stbNOI;
  const exitValue = exitCapCons>0 ? (exitNOI/exitCapCons) : 0;
  const netSale = exitValue * (1 - saleCostPct);
  // payoff estimate: principal + (no amort assumption beyond dsAnnual calc; keep conservative)
  const payoff = totalDebt;
  const saleCoverage = safeDiv(netSale, payoff);
  const impliedSaleLoss = Math.max(0, payoff - netSale);

  // Takeout feasibility: compute max takeout loan based on DSCR requirement at takeout rate/amort
  const takeoutDSper$ = annDebtService(1_000_000, takeoutRate, takeoutAmort) / 1_000_000;
  const maxTakeout = (takeoutDSper$>0) ? (exitNOI / (takeoutDSCR * takeoutDSper$)) : 0;
  const takeoutLTV = safeDiv(maxTakeout, exitValue)*100;

  // Lender economics (simplified)
  const termYears = termMo/12;
  const grossInt = loanAmt*(noteRate/100)*termYears;
  const ptsIncome = loanAmt*(points/100);
  const income = grossInt + ptsIncome + otherFees + exitFee;
  const cofCost = (loanAmt*cofPct)*(cof/100)*termYears;
  const netLender = income - cofCost;
  const roa = safeDiv(netLender, loanAmt)*100;
  const lenderEquity = loanAmt*(1-cofPct);
  const coc = safeDiv(netLender, lenderEquity)*100;

  // Construction carry estimation
  const interestReserve = safeNum($("interestReserve").value);
  const stabMonths = safeNum($("stabMonths").value) || (safeNum($("constMonths").value)+safeNum($("leaseupMonths").value));
  const carryBufferMo = safeNum($("carryBufferMo").value);
  const avgUtilPct = safeNum($("avgUtilPct").value)/100;
  const leaseupDef = safeNum($("leaseupDef").value);
  const carryMonths = Math.max(0, stabMonths + carryBufferMo);
  const avgBal = loanAmt * clamp(avgUtilPct,0,1);
  const carryInterest = avgBal*(noteRate/100)*(carryMonths/12);
  const carryDeficit = leaseupDef*carryMonths;
  const carryNeed = carryInterest + carryDeficit;
  const carryGap = carryNeed - interestReserve;

  // Stress tests
  const stRentDown = safeNum($("stRentDown").value)/100;
  const stVacUp = safeNum($("stVacUp").value)/100;
  const stCapBps = safeNum($("stCapBps").value)/10000;
  const stRateBps = safeNum($("stRateBps").value)/10000;
  const stCostOver = safeNum($("stCostOver").value)/100;
  const stDelayMo = safeNum($("stDelayMo").value);

  const stGrossRent = stbGrossRent*(1-stRentDown);
  const stGI = stGrossRent + stbOtherIncome;
  const stVac = clamp(stbVacPct + stVacUp, 0, 0.50);
  const stEGI = stGI*(1 - stVac - badDebtPct);
  const stOpEx = stbOpEx*(1+expG); // mild expense shock
  const stNOI = stEGI - stOpEx;

  const stRate = noteRate + (stRateBps*100);
  const stDS = annInterestOnly(loanAmt, stRate); // conservative sensitivity
  const stDSCR = safeDiv(stNOI, stDS);

  const stExitCap = exitCapCons + stCapBps;
  const stExitValue = stExitCap>0 ? (stNOI/stExitCap) : 0;
  const stNetSale = stExitValue*(1-saleCostPct);
  const stSaleCoverage = safeDiv(stNetSale, payoff);
  const stImpliedLoss = Math.max(0, payoff - stNetSale);

  const stHard = rehab*(1+stCostOver);
  const stUses = (totalUsesOverride>0? totalUsesOverride : (purchase+borClosing+stHard+soft+(stHard*contPct)+estCarry+leasingCosts));
  const stLTC = safeDiv(loanAmt, stUses)*100;

  // Forced sale
  const forcedDisc = safeNum($("forcedDisc").value)/100;
  const workoutCost = safeNum($("workoutCost").value)/100;
  const forcedValue = asIs*(1-forcedDisc);
  const netForced = forcedValue*(1-workoutCost);
  const forcedCoverage = safeDiv(netForced, payoff);
  const forcedLoss = Math.max(0, payoff - netForced);

  // Sponsor / PFS
  const pfsCash = safeNum($("pfsCash").value);
  const pfsMarket = safeNum($("pfsMarket").value);
  const pfsOtherLiq = safeNum($("pfsOtherLiq").value);
  const pfsReEq = safeNum($("pfsReEq").value);
  const pfsBiz = safeNum($("pfsBiz").value);
  const pfsOther = safeNum($("pfsOther").value);
  const pfsLiab = safeNum($("pfsLiab").value);
  const contLiab = safeNum($("contLiab").value);
  const liqHaircut = safeNum($("liqHaircut").value)/100;
  const reHaircut = safeNum($("reHaircut").value)/100;

  const grossLiq = pfsCash + pfsMarket + pfsOtherLiq;
  const adjLiq = grossLiq*(1-liqHaircut);
  const adjRe = pfsReEq*(1-reHaircut);
  const nw = (grossLiq + pfsReEq + pfsBiz + pfsOther) - pfsLiab;
  const adjNW = (adjLiq + adjRe + pfsBiz + pfsOther) - (pfsLiab + contLiab*0.5); // haircutted contingent
  const liqToLoan = safeDiv(adjLiq, loanAmt);

  // Global
  const globalNoi = safeNum($("globalNoi").value);
  const globalDebtSvc = safeNum($("globalDebtSvc").value);
  const living = safeNum($("living").value);
  const otherDebt = safeNum($("otherDebt").value);
  const globalDSCR = safeDiv((globalNoi - living), (globalDebtSvc + otherDebt));
  const globalWithDeal = safeDiv((globalNoi - living), (globalDebtSvc + otherDebt + dsAnnual));
  const globVacSens = safeNum($("globVacSens").value)/100;
  const globRateBps = safeNum($("globRateBps").value)/10000;
  const globalNoiStress = globalNoi*(1-globVacSens);
  const globalDebtStress = globalDebtSvc*(1 + (globRateBps*2)); // rough
  const globalStressDSCR = safeDiv((globalNoiStress - living), (globalDebtStress + otherDebt + stDS));

  // Liquidity burn under delay stress (property deficit * delay)
  const stMonthlyDef = Math.max(0, (stDS - stNOI)/12);
  const liqBurn = stMonthlyDef * stDelayMo;
  const liqAfterBurn = Math.max(0, adjLiq - liqBurn);

  // Market / diligence scoring
  const liqScore = safeNum($("liqScore").value);
  const tts = safeNum($("tts").value);
  const pipeline = $("pipeline").value;
  const mktVacTrend = $("mktVacTrend").value;

  // Diligence readiness
  const titleOk = $("titleOk").value;
  const zoning = $("zoning").value;
  const phaseRes = $("phaseRes").value;
  const insOk = $("insOk").value;
  const appRev = $("appRev").value;

  // Risk rating (weighted)
  const wLev = safeNum($("wLev").value);
  const wCF = safeNum($("wCF").value);
  const wSp = safeNum($("wSp").value);
  const wCol = safeNum($("wCol").value);
  const wSum = Math.max(1, wLev+wCF+wSp+wCol);

  const levScore = scoreLeverage({prod, ltv, cltv, ltc, lienPos});
  const cfScore  = scoreCashflow({prod, dscrStb, stDSCR, dyStb});
  const spScore  = scoreSponsor({adjLiq, adjNW, liqToLoan, globalWithDeal, liqAfterBurn});
  const colScore = scoreCollateral({liqScore, tts, pipeline, mktVacTrend});

  const composite = (levScore*wLev + cfScore*wCF + spScore*wSp + colScore*wCol)/wSum;
  const rating = toRating(composite);
  const rec = recommend({prod, dscrStb, stDSCR, ltv, ltc, forcedCoverage, globalWithDeal, rating, titleOk, zoning, phaseRes, insOk, appRev});

  $("hdrRec").textContent = rec.status;
  $("hdrRisk").textContent = `${rating.code} (${Math.round(composite)})`;

  // Build Auto Conditions (baseline)
  const autoConds = buildConditions({prod, recourse:$("recourse").value, lienPos, titleOk, zoning, phaseRes, insOk, appRev, permits:$("permits").value});
  if(!$("conds").value.trim()) $("conds").value = autoConds.join("\n");

  // Render all page KPIs
  renderCompleteness({loanAmt, asIs, stbGrossRent, pfsCash, takeoutRate, titleOk});
  renderPayments({loanAmt, noteRate, amortY, termMo, ioMo, dsAnnual, annIO, annAm});
  renderEconomics({income, cofCost, netLender, roa, coc, targetROA:safeNum($("targetROA").value), targetCoC:safeNum($("targetCoC").value)});
  renderSU({sources, totalUses, gap, contingency, contPct, stUses, stLTC});
  renderMarket({liqScore, tts, pipeline, mktVacTrend});
  renderHist({grossIncome, egi, opEx, noi, dsAnnual, dscrHist, breakeven});
  renderPF({stbGI, stbEGI, stbOpEx, stbNOI, dsAnnual, dscrStb, dyStb, exitValue, netSale, saleCoverage, impliedSaleLoss, maxTakeout, takeoutLTV});
  renderProj(proj);
  renderCarry({carryMonths, avgBal, carryInterest, carryDeficit, carryNeed, interestReserve, carryGap});
  renderSponsor({grossLiq, adjLiq, nw, adjNW, liqToLoan, liqAfterBurn, liqBurn});
  renderGlobal({globalDSCR, globalWithDeal, globalStressDSCR});
  renderGlobalSensitivity({globalNoi, globalDebtSvc, living, otherDebt, dsAnnual});
  renderStress({stNOI, stDS, stDSCR, stExitValue, stNetSale, stSaleCoverage, stImpliedLoss, forcedValue, netForced, forcedCoverage, forcedLoss, stLTC});
  renderMatrix({stbNOI, loanAmt, noteRate, exitCapCons});
  renderStressNarr({stDSCR, stSaleCoverage, forcedCoverage, liqAfterBurn});
  renderDiligence({titleOk, zoning, phaseRes, insOk, appRev});
  renderRating({levScore, cfScore, spScore, colScore, composite, rating});
  renderPricingGuide({rating});
  renderRatingNarr({rating, rec, ltv, ltc, dscrStb, dyStb, forcedCoverage, globalWithDeal});
  renderMonitoringNarr({rec, covDSCR:safeNum($("covDSCR").value), covLTV:safeNum($("covLTV").value), sweep:safeNum($("sweepDSCR").value)});
  renderOutputs({deal, prod, rec, rating, loanAmt, termMo, ioMo, noteRate, points, ltv, ltvStb, cltv, cltvStb, ltc,
                 noi, stbNOI, dsAnnual, dscrHist, dscrStb, stDSCR, dyStb, breakeven,
                 exitValue, netSale, saleCoverage, impliedSaleLoss, maxTakeout, takeoutLTV,
                 forcedCoverage, forcedLoss, globalWithDeal, adjLiq, adjNW, liqAfterBurn, liqBurn, autoConds});
  renderQuality({deal, loanAmt, asIs, stbNOI, takeoutDSCR, maxTakeout, titleOk, zoning, phaseRes, insOk, appRev, rating, rec, rentComps:$("rentComps").value, saleComps:$("saleComps").value, txNarr:$("txNarr").value});

  // Save last calc snapshot
  last = { deal, prod, loanAmt, termMo, ioMo, noteRate, points, otherFees, exitFee, dsAnnual, noi, stbNOI, dscrStb, dyStb, ltv, ltc, exitValue, saleCoverage, forcedCoverage, composite, rating, rec };
  persistDraft();
}

/* =========================================================
   Scoring + Recommendation
========================================================= */
function scoreLeverage(m){
  // 0 best -> 100 worst
  const l = (m.lienPos==="1st") ? m.ltv : m.cltv;
  let s = 0;
  // Product baseline (higher risk)
  const base = { dscr:10, commercial_bridge:14, bridge:16, fixflip:20, construction:24, land:26, second_lien:30 }[m.prod] ?? 18;
  s += base;

  // Leverage
  if(l<=60) s += 10;
  else if(l<=70) s += 18;
  else if(l<=80) s += 30;
  else if(l<=90) s += 44;
  else s += 56;

  // LTC
  if(m.ltc<=60) s += 10;
  else if(m.ltc<=70) s += 18;
  else if(m.ltc<=80) s += 30;
  else if(m.ltc<=90) s += 42;
  else s += 52;

  return clamp(s,0,100);
}
function scoreCashflow(m){
  let s=0;
  // DSCR
  if(m.prod==="fixflip"||m.prod==="construction"||m.prod==="land"){
    // value-add: DSCR still matters but less determinative
    if(m.dscrStb>=1.20) s+=18;
    else if(m.dscrStb>=1.10) s+=28;
    else if(m.dscrStb>=1.00) s+=40;
    else s+=55;
  } else {
    if(m.dscrStb>=1.35) s+=12;
    else if(m.dscrStb>=1.20) s+=22;
    else if(m.dscrStb>=1.10) s+=36;
    else if(m.dscrStb>=1.00) s+=52;
    else s+=68;
  }
  // Stress DSCR
  if(m.stDSCR>=1.10) s+=10;
  else if(m.stDSCR>=1.00) s+=18;
  else if(m.stDSCR>=0.90) s+=28;
  else s+=40;

  // Debt Yield
  if(m.dyStb>=12) s+=10;
  else if(m.dyStb>=10) s+=16;
  else if(m.dyStb>=8) s+=26;
  else s+=38;

  return clamp(s,0,100);
}
function scoreSponsor(m){
  let s=0;
  if(m.adjNW<=0) s+=55;
  else if(m.adjNW<500000) s+=42;
  else if(m.adjNW<2000000) s+=32;
  else s+=22;

  if(m.adjLiq<50000) s+=40;
  else if(m.adjLiq<250000) s+=30;
  else if(m.adjLiq<750000) s+=22;
  else s+=14;

  // Liquidity relative to loan
  if(m.liqToLoan>=0.25) s+=10;
  else if(m.liqToLoan>=0.10) s+=18;
  else if(m.liqToLoan>=0.05) s+=26;
  else s+=34;

  // Global DSCR
  if(m.globalWithDeal>=1.25) s+=10;
  else if(m.globalWithDeal>=1.15) s+=16;
  else if(m.globalWithDeal>=1.05) s+=24;
  else s+=34;

  // Liquidity after burn
  if(m.liqAfterBurn>=250000) s+=8;
  else if(m.liqAfterBurn>=75000) s+=14;
  else s+=22;

  return clamp(s,0,100);
}
function scoreCollateral(m){
  let s=0;
  // liquidity score 1 best -> 5 worst
  s += (m.liqScore-1)*12; // 0..48
  if(m.tts<=3) s+=8;
  else if(m.tts<=6) s+=14;
  else if(m.tts<=9) s+=22;
  else s+=30;

  if(m.pipeline==="High") s+=10;
  else if(m.pipeline==="Moderate") s+=6;

  if(m.mktVacTrend==="Softening") s+=10;
  else if(m.mktVacTrend==="Stable") s+=6;

  return clamp(s,0,100);
}
function toRating(score){
  // Example: 1-10 style
  if(score<=20) return {code:"1", desc:"Low Risk"};
  if(score<=30) return {code:"2", desc:"Low‑Moderate"};
  if(score<=40) return {code:"3", desc:"Moderate"};
  if(score<=50) return {code:"4", desc:"Moderate‑Elevated"};
  if(score<=60) return {code:"5", desc:"Elevated"};
  if(score<=70) return {code:"6", desc:"High"};
  if(score<=80) return {code:"7", desc:"Very High"};
  return {code:"8", desc:"Workout / Special Mention"};
}
function recommend(m){
  // Conservative gating
  const minDSCR = safeNum($("policyMinDSCR").value);
  let status="Approve";
  const rationale=[];
  if(m.rating.code>="7"){ status="Decline"; rationale.push("Composite risk rating exceeds tolerance."); }
  else if(m.rating.code>="6"){ status="Approve with Conditions"; rationale.push("High risk rating; tighten leverage/reserves/controls."); }
  else if(m.rating.code>="5"){ status="Approve with Conditions"; rationale.push("Elevated risk rating; require mitigants."); }

  if(m.prod==="dscr" && m.dscrStb < Math.max(minDSCR,1.15)){ status="Decline"; rationale.push("Stabilized DSCR below policy minimum for cash‑flow lending."); }
  if(m.ltv>90 && m.prod!=="land"){ status="Decline"; rationale.push("As‑is leverage exceeds policy cap."); }
  if(m.ltc>90){ status="Approve with Conditions"; rationale.push("High LTC; require additional equity or reserves."); }
  if(m.forcedCoverage<0.90){ status="Approve with Conditions"; rationale.push("Forced sale proceeds may not cover total debt net of workout costs."); }
  if(m.globalWithDeal<1.05){ status="Approve with Conditions"; rationale.push("Weak global cash flow reduces sponsor capacity under stress."); }

  // Diligence gating (convert to conditions, not always immediate decline)
  const diligenceIssues=[];
  if(m.titleOk==="No") diligenceIssues.push("Unacceptable title exceptions.");
  if(m.zoning==="No") diligenceIssues.push("Zoning / use not confirmed.");
  if(m.phaseRes==="RECs Identified") diligenceIssues.push("Environmental RECs identified; require resolution/Phase II where applicable.");
  if(m.insOk==="No") diligenceIssues.push("Insurance not adequate.");
  if(m.appRev==="No") diligenceIssues.push("Appraisal not reviewed.");
  if(diligenceIssues.length){
    if(status==="Approve") status="Approve with Conditions";
    rationale.push("Diligence items outstanding: " + diligenceIssues.join(" "));
  }

  return {status, rationale};
}
function buildConditions(m){
  const conds=[];
  conds.push("Satisfactory third‑party valuation (Appraisal/BPO) supporting as‑is and stabilized assumptions.");
  conds.push("Title policy (loan policy) with required endorsements; no unacceptable exceptions; lender-approved settlement agent.");
  conds.push("Evidence of hazard/wind/flood (as applicable) with lender as mortgagee/additional insured; builder’s risk for construction.");
  if(m.prod==="construction"||m.prod==="fixflip"){
    conds.push("Third‑party budget review; executed GC contract; lender-approved draw/inspection protocol with lien waivers each draw.");
    conds.push("Contingency held lender-controlled to cover overruns; minimum contingency per policy.");
    if(m.permits!=="yes") conds.push("Evidence of permits/entitlements sufficient to commence work prior to first draw.");
  }
  if(m.prod==="bridge"||m.prod==="commercial_bridge"||m.prod==="construction"){
    conds.push("Interest reserve funded/held back as needed to cover projected carry through stabilization (including buffer).");
  }
  if(m.recourse!=="non") conds.push("Personal guaranty from financially capable sponsor; verification of liquidity and contingent liabilities.");
  conds.push("Ongoing reporting: monthly rent roll, quarterly operating statement, annual taxes/insurance evidence, and material lease updates.");
  if(m.phaseRes==="RECs Identified") conds.push("Environmental: address RECs per Phase I; Phase II / remediation if required.");
  if(m.zoning==="No") conds.push("Zoning/use confirmation and lender acceptance prior to closing.");
  return conds;
}

/* =========================================================
   Renderers
========================================================= */
function renderCompleteness(m){
  // Core 6: loan amount, as-is value, stabilized rent, sponsor cash, takeout rate, title ok
  const k=[];
  k.push(kpiCard("Loan Amount", fmt$(m.loanAmt), tagFor(m.loanAmt, x=>x>0, x=>x>0), "required"));
  k.push(kpiCard("As‑Is Value", fmt$(m.asIs), tagFor(m.asIs, x=>x>0, x=>x>0), "required"));
  k.push(kpiCard("Stabilized Rent", fmt$(m.stbGrossRent), tagFor(m.stbGrossRent, x=>x>0, x=>x>0), "required"));
  k.push(kpiCard("Sponsor Cash (PFS)", fmt$(m.pfsCash), tagFor(m.pfsCash, x=>x>0, x=>x>0), "required"));
  k.push(kpiCard("Takeout Rate", fmtPct(m.takeoutRate,2), tagFor(m.takeoutRate, x=>x>0, x=>x>0), "required"));
  k.push(kpiCard("Title Acceptable", escapeHtml(m.titleOk||"Unknown"), tagFor(m.titleOk, x=>x==="Yes", x=>x!=="No"), "required"));
  $("kpiCompleteness").innerHTML = k.join("");
}
function renderPayments(m){
  const k=[];
  const mIO = m.annIO/12;
  const mAm = m.annAm/12;
  k.push(kpiCard("Monthly IO Pmt", fmt$(mIO), tagFor(mIO, x=>x>0, x=>x>0)));
  k.push(kpiCard("Monthly Amort Pmt", fmt$(mAm), tagFor(mAm, x=>x>0, x=>x>0)));
  k.push(kpiCard("Annual Debt Service (UW)", fmt$(m.dsAnnual), tagFor(m.dsAnnual, x=>x>0, x=>x>0)));
  k.push(kpiCard("IO vs Term", `${Math.min(m.ioMo,m.termMo)} / ${m.termMo} mo`, tagFor(m.ioMo, x=>x>=m.termMo, x=>x>0), "IO months"));
  $("kpiPayments").innerHTML = k.join("");
}
function renderEconomics(m){
  const k=[];
  k.push(kpiCard("Total Lender Income", fmt$(m.income), tagFor(m.income, x=>x>0, x=>x>0)));
  k.push(kpiCard("Cost of Funds", fmt$(m.cofCost), tagFor(m.cofCost, x=>x>=0, x=>x>=0)));
  k.push(kpiCard("Net Income (Term)", fmt$(m.netLender), tagFor(m.netLender, x=>x>0, x=>x>=0)));
  k.push(kpiCard("ROA (Term)", fmtPct(m.roa,2), tagFor(m.roa, x=>x>=m.targetROA, x=>x>=m.targetROA*0.85), `target ${m.targetROA}%`));
  k.push(kpiCard("CoC (Equity)", fmtPct(m.coc,2), tagFor(m.coc, x=>x>=m.targetCoC, x=>x>=m.targetCoC*0.85), `target ${m.targetCoC}%`));
  $("kpiEconomics").innerHTML = k.join("");
}
function renderSU(m){
  const k=[];
  k.push(kpiCard("Total Uses", fmt$(m.totalUses), tagFor(m.totalUses, x=>x>0, x=>x>0)));
  k.push(kpiCard("Total Sources", fmt$(m.sources), tagFor(m.sources, x=>x>0, x=>x>0)));
  k.push(kpiCard("Sources‑Uses Gap", fmt$(m.gap), tagFor(m.gap, x=>Math.abs(x)<=100, x=>Math.abs(x)<=5000), "must ≈ 0"));
  k.push(kpiCard("Contingency", fmt$(m.contingency), tagFor(m.contingency, x=>x>=0.10*safeNum($("rehabBudget").value), x=>x>=0.05*safeNum($("rehabBudget").value)), "rule of thumb"));
  k.push(kpiCard("Stress LTC", fmtPct(m.stLTC,1), tagFor(m.stLTC, x=>x<=80, x=>x<=90), "overrun case"));
  $("kpiSU").innerHTML = k.join("");

  const box=$("gapBox");
  if(Math.abs(m.gap)>100){
    box.style.display="block";
    box.innerHTML = `<strong>Gap Detected:</strong> Sources (${fmt$(m.sources)}) do not equal Uses (${fmt$(m.totalUses)}). The gap is ${fmt$(m.gap)}. <br><br>
    <em>Institutional note:</em> A deal with an unexplained gap is not ready for approval. Identify the exact source or reduce uses.`;
  }else{
    box.style.display="none";
  }
}
function renderMarket(m){
  const k=[];
  k.push(kpiCard("Liquidity Score", `${m.liqScore}/5`, tagFor(m.liqScore, x=>x<=2, x=>x<=3), "lower is better"));
  k.push(kpiCard("Time‑to‑Sell", `${m.tts} mo`, tagFor(m.tts, x=>x<=6, x=>x<=9)));
  k.push(kpiCard("Supply Pipeline", escapeHtml(m.pipeline), tagFor(m.pipeline, x=>x==="Low", x=>x!=="High")));
  k.push(kpiCard("Vacancy Trend", escapeHtml(m.mktVacTrend), tagFor(m.mktVacTrend, x=>x==="Improving", x=>x==="Stable")));
  $("kpiMarket").innerHTML = k.join("");
}
function renderHist(m){
  const k=[];
  k.push(kpiCard("Gross Income", fmt$(m.grossIncome), tagFor(m.grossIncome, x=>x>0, x=>x>0)));
  k.push(kpiCard("Effective Gross Income", fmt$(m.egi), tagFor(m.egi, x=>x>0, x=>x>0)));
  k.push(kpiCard("Operating Expenses", fmt$(m.opEx), tagFor(m.opEx, x=>x>=0, x=>x>=0)));
  k.push(kpiCard("NOI (Normalized)", fmt$(m.noi), tagFor(m.noi, x=>x>0, x=>x>=0)));
  k.push(kpiCard("DSCR (In‑Place)", fmtX(m.dscrHist,2), tagFor(m.dscrHist, x=>x>=1.20, x=>x>=1.10)));
  k.push(kpiCard("Breakeven Ratio", fmtPct(m.breakeven,1), tagFor(m.breakeven, x=>x<=80, x=>x<=90)));
  $("kpiHist").innerHTML = k.join("");
}
function renderPF(m){
  const k=[];
  k.push(kpiCard("Stabilized NOI", fmt$(m.stbNOI), tagFor(m.stbNOI, x=>x>0, x=>x>=0)));
  k.push(kpiCard("DSCR (Stabilized)", fmtX(m.dscrStb,2), tagFor(m.dscrStb, x=>x>=safeNum($("policyMinDSCR").value), x=>x>=safeNum($("policyMinDSCR").value)*0.92)));
  k.push(kpiCard("Debt Yield (Stb)", fmtPct(m.dyStb,2), tagFor(m.dyStb, x=>x>=10, x=>x>=8)));
  k.push(kpiCard("Exit Value (Cons.)", fmt$(m.exitValue), tagFor(m.exitValue, x=>x>0, x=>x>0)));
  k.push(kpiCard("Sale Coverage", fmtX(m.saleCoverage,2), tagFor(m.saleCoverage, x=>x>=1.0, x=>x>=0.9)));
  k.push(kpiCard("Implied Sale Loss", fmt$(m.impliedSaleLoss), tagFor(m.impliedSaleLoss, x=>x<=0, x=>x<=0)));
  k.push(kpiCard("Max Takeout Loan", fmt$(m.maxTakeout), tagFor(m.maxTakeout, x=>x>=safeNum($("loanAmount").value), x=>x>=safeNum($("loanAmount").value)*0.9)));
  k.push(kpiCard("Takeout LTV", fmtPct(m.takeoutLTV,1), tagFor(m.takeoutLTV, x=>x<=70, x=>x<=75)));
  $("kpiPF").innerHTML = k.join("");
}
function renderProj(proj){
  const tbl = `
    <table class="table">
      <thead><tr><th>Year</th><th class="right">Gross</th><th class="right">EGI</th><th class="right">OpEx</th><th class="right">NOI</th><th class="right">Debt Svc</th><th class="right">DSCR</th></tr></thead>
      <tbody>
        ${proj.map(r=>`
          <tr>
            <td class="mono">${r.year}</td>
            <td class="mono right">${fmt$(r.gross)}</td>
            <td class="mono right">${fmt$(r.egi)}</td>
            <td class="mono right">${fmt$(r.opex)}</td>
            <td class="mono right">${fmt$(r.noi)}</td>
            <td class="mono right">${fmt$(r.ds)}</td>
            <td class="mono right">${fmtX(r.dscr,2)}</td>
          </tr>`).join("")}
      </tbody>
    </table>`;
  $("projWrap").innerHTML = tbl;
}
function renderCarry(m){
  const k=[];
  k.push(kpiCard("Carry Months", `${m.carryMonths} mo`, tagFor(m.carryMonths, x=>x>=0, x=>x>=0)));
  k.push(kpiCard("Avg Balance", fmt$(m.avgBal), tagFor(m.avgBal, x=>x>=0, x=>x>=0)));
  k.push(kpiCard("Est. Interest Carry", fmt$(m.carryInterest), tagFor(m.carryInterest, x=>x>=0, x=>x>=0)));
  k.push(kpiCard("Est. Op Deficit", fmt$(m.carryDeficit), tagFor(m.carryDeficit, x=>x>=0, x=>x>=0)));
  k.push(kpiCard("Total Carry Need", fmt$(m.carryNeed), tagFor(m.carryNeed, x=>x>=0, x=>x>=0)));
  k.push(kpiCard("Interest Reserve", fmt$(safeNum($("interestReserve").value)), tagFor(safeNum($("interestReserve").value), x=>x>=m.carryNeed, x=>x>=m.carryNeed*0.8)));
  $("kpiCarry").innerHTML = k.join("");

  const w=$("carryWarn");
  if(m.carryGap>0){
    w.style.display="block";
    w.innerHTML = `<strong>Reserve Gap:</strong> Estimated carry need ${fmt$(m.carryNeed)} exceeds interest reserve ${fmt$(safeNum($("interestReserve").value))} by ${fmt$(m.carryGap)}.
      <br><br>Mitigants: (i) increase reserve, (ii) reduce leverage, (iii) shorten stabilization timeline, (iv) require sponsor liquidity covenant/top-up, or (v) require principal curtailment at milestones.`;
  }else{
    w.style.display="none";
  }
}
function renderSponsor(m){
  const k=[];
  k.push(kpiCard("Gross Liquidity", fmt$(m.grossLiq), tagFor(m.grossLiq, x=>x>=250000, x=>x>=75000)));
  k.push(kpiCard("Adj. Liquidity", fmt$(m.adjLiq), tagFor(m.adjLiq, x=>x>=250000, x=>x>=75000), "haircutted"));
  k.push(kpiCard("Net Worth", fmt$(m.nw), tagFor(m.nw, x=>x>=2000000, x=>x>=500000)));
  k.push(kpiCard("Adj. Net Worth", fmt$(m.adjNW), tagFor(m.adjNW, x=>x>=2000000, x=>x>=500000), "haircutted"));
  k.push(kpiCard("Liquidity / Loan", fmtPct(m.liqToLoan*100,1), tagFor(m.liqToLoan, x=>x>=0.10, x=>x>=0.05)));
  k.push(kpiCard("Liquidity After Delay", fmt$(m.liqAfterBurn), tagFor(m.liqAfterBurn, x=>x>=250000, x=>x>=75000)));
  $("kpiSponsor").innerHTML = k.join("");

  const w=$("sponsorWarn");
  if(m.liqAfterBurn<75000 && safeNum($("loanAmount").value)>0){
    w.style.display="block";
    w.innerHTML = `<strong>Sponsor support risk:</strong> Liquidity after delay burn is estimated at ${fmt$(m.liqAfterBurn)}. Consider requiring: larger reserves, additional collateral, or tighter leverage.`;
  }else{
    w.style.display="none";
  }
}
function renderGlobal(m){
  const k=[];
  k.push(kpiCard("Global DSCR", fmtX(m.globalDSCR,2), tagFor(m.globalDSCR, x=>x>=1.20, x=>x>=1.10)));
  k.push(kpiCard("Global DSCR (w/ Deal)", fmtX(m.globalWithDeal,2), tagFor(m.globalWithDeal, x=>x>=1.15, x=>x>=1.05)));
  k.push(kpiCard("Global Stress DSCR", fmtX(m.globalStressDSCR,2), tagFor(m.globalStressDSCR, x=>x>=1.00, x=>x>=0.90)));
  $("kpiGlobal").innerHTML = k.join("");
}
function renderGlobalSensitivity(m){
  const baseNoi=safeNum(m.globalNoi), baseDs=safeNum(m.globalDebtSvc), living=safeNum(m.living), other=safeNum(m.otherDebt), deal=safeNum(m.dsAnnual);
  const vac = [0, .05, .10];
  const rate = [0, .10, .20];
  let html=`<table class="table"><thead><tr><th></th>${rate.map(r=>`<th class="right">DS +${Math.round(r*100)}%</th>`).join("")}</tr></thead><tbody>`;
  vac.forEach(v=>{
    html += `<tr><th>NOI -${Math.round(v*100)}%</th>`;
    rate.forEach(r=>{
      const noi = baseNoi*(1-v) - living;
      const ds  = baseDs*(1+r) + other + deal;
      const g = safeDiv(noi, ds);
      html += `<td class="mono right">${fmtX(g,2)}</td>`;
    });
    html += `</tr>`;
  });
  html += `</tbody></table>`;
  $("globSens").innerHTML = html;
}
function renderStress(m){
  const k=[];
  k.push(kpiCard("Stress NOI", fmt$(m.stNOI), tagFor(m.stNOI, x=>x>0, x=>x>=0)));
  k.push(kpiCard("Stress Debt Service", fmt$(m.stDS), tagFor(m.stDS, x=>x>0, x=>x>0)));
  k.push(kpiCard("Stress DSCR", fmtX(m.stDSCR,2), tagFor(m.stDSCR, x=>x>=1.00, x=>x>=0.90)));
  k.push(kpiCard("Stress Exit Value", fmt$(m.stExitValue), tagFor(m.stExitValue, x=>x>0, x=>x>0)));
  k.push(kpiCard("Stress Sale Coverage", fmtX(m.stSaleCoverage,2), tagFor(m.stSaleCoverage, x=>x>=1.0, x=>x>=0.9)));
  k.push(kpiCard("Stress Implied Loss", fmt$(m.stImpliedLoss), tagFor(m.stImpliedLoss, x=>x<=0, x=>x<=0)));
  k.push(kpiCard("Forced Coverage", fmtX(m.forcedCoverage,2), tagFor(m.forcedCoverage, x=>x>=1.0, x=>x>=0.9)));
  k.push(kpiCard("Forced Loss", fmt$(m.forcedLoss), tagFor(m.forcedLoss, x=>x<=0, x=>x<=0)));
  k.push(kpiCard("Stress LTC", fmtPct(m.stLTC,1), tagFor(m.stLTC, x=>x<=80, x=>x<=90)));
  $("kpiStress").innerHTML = k.join("");
}
function renderMatrix(m){
  const noi = safeNum(m.stbNOI);
  const loan = safeNum(m.loanAmt);
  const rate = safeNum(m.noteRate)/100;
  const baseCap = safeNum(m.exitCapCons);
  const capSteps = [-0.005, 0, 0.005, 0.01]; // +/- 50-100 bps
  const noiSteps = [-0.10, 0, 0.10]; // NOI down/up
  let html=`<table class="table"><thead><tr><th>NOI \\ Cap</th>${capSteps.map(c=>`<th class="right">${fmtPct((baseCap+c)*100,2)}</th>`).join("")}</tr></thead><tbody>`;
  noiSteps.forEach(nc=>{
    const n = noi*(1+nc);
    html += `<tr><th>NOI ${nc<0?nc*100:("+"+nc*100)}%</th>`;
    capSteps.forEach(c=>{
      const cap = baseCap + c;
      const val = cap>0? n/cap : 0;
      const cover = safeDiv(val, loan);
      html += `<td class="mono right">${fmtX(cover,2)}</td>`;
    });
    html += `</tr>`;
  });
  html += `</tbody></table>
    <div class="footerNote">Table shows <strong>Value / Loan</strong> under NOI & cap shifts. Below 1.00× indicates principal impairment risk unless sponsor support exists.</div>`;
  $("sensMatrix").innerHTML = html;
}
function renderStressNarr(m){
  const lines=[];
  if(m.stDSCR<1.0) lines.push("Under the defined downside case, stressed cash flow does not fully cover debt service, indicating reliance on sponsor support/reserves.");
  else lines.push("Under the defined downside case, stressed cash flow remains near/above debt service, providing some survivability buffer.");
  if(m.stSaleCoverage<1.0) lines.push("A stressed sale scenario implies potential principal impairment net of sales costs; structure should be tightened or additional support required.");
  if(m.forcedCoverage<0.9) lines.push("Forced sale analysis indicates elevated loss severity risk; this is a key private-credit failure mode.");
  if(m.liqAfterBurn<75000) lines.push("Sponsor liquidity after delay burn appears limited; require reserves/top-up covenants or reduce leverage.");
  $("stressNarr").innerHTML = `<ul>${lines.map(x=>`<li>${escapeHtml(x)}</li>`).join("")}</ul>`;
}
function renderDiligence(m){
  const k=[];
  k.push(kpiCard("Title OK?", escapeHtml(m.titleOk), tagFor(m.titleOk, x=>x==="Yes", x=>x==="Unknown")));
  k.push(kpiCard("Zoning Verified?", escapeHtml(m.zoning), tagFor(m.zoning, x=>x==="Yes", x=>x==="Unknown")));
  k.push(kpiCard("Phase I Result", escapeHtml(m.phaseRes), tagFor(m.phaseRes, x=>x==="Clean"||x==="Not Applicable", x=>x==="Pending")));
  k.push(kpiCard("Insurance OK?", escapeHtml(m.insOk), tagFor(m.insOk, x=>x==="Yes", x=>x==="Unknown")));
  k.push(kpiCard("Appraisal Reviewed?", escapeHtml(m.appRev), tagFor(m.appRev, x=>x==="Yes", x=>x==="No")));
  $("kpiDiligence").innerHTML = k.join("");

  const warn=[];
  if(m.titleOk==="No") warn.push("Title exceptions unacceptable.");
  if(m.zoning==="No") warn.push("Zoning/use not confirmed.");
  if(m.phaseRes==="RECs Identified") warn.push("Environmental RECs identified.");
  if(m.insOk==="No") warn.push("Insurance inadequate.");
  if(m.appRev==="No") warn.push("Appraisal not reviewed.");
  const w=$("dilWarn");
  if(warn.length){
    w.style.display="block";
    w.innerHTML = `<strong>Diligence Flags:</strong> ${warn.map(escapeHtml).join(" ")}<br><br>Recommendation: condition approval on satisfactory resolution and document review.`;
  }else{
    w.style.display="none";
  }
}
function renderRating(m){
  const k=[];
  k.push(kpiCard("Leverage Score", `${Math.round(m.levScore)}`, tagFor(m.levScore, x=>x<=35, x=>x<=55)));
  k.push(kpiCard("Cash Flow Score", `${Math.round(m.cfScore)}`, tagFor(m.cfScore, x=>x<=35, x=>x<=55)));
  k.push(kpiCard("Sponsor Score", `${Math.round(m.spScore)}`, tagFor(m.spScore, x=>x<=35, x=>x<=55)));
  k.push(kpiCard("Collateral Score", `${Math.round(m.colScore)}`, tagFor(m.colScore, x=>x<=35, x=>x<=55)));
  k.push(kpiCard("Composite", `${Math.round(m.composite)}`, tagFor(m.composite, x=>x<=40, x=>x<=60), `rating ${m.rating.code}`));
  k.push(kpiCard("Rating", `${m.rating.code} – ${escapeHtml(m.rating.desc)}`, tagFor(Number(m.rating.code), x=>x<=4, x=>x<=6)));
  $("kpiRating").innerHTML = k.join("");
}
function renderPricingGuide(m){
  // simplistic guide (replace with your matrix)
  const r = Number(m.rating.code);
  const baseSpread = 6.0 + (r*0.5); // placeholder
  const pts = 1.0 + Math.max(0,(r-3))*0.25;
  const html = [
    kpiCard("Suggested Spread (over COF)", fmtPct(baseSpread,2), tagFor(r, x=>x<=4, x=>x<=6), "advisory"),
    kpiCard("Suggested Points", fmtPct(pts,2), tagFor(r, x=>x<=4, x=>x<=6), "advisory"),
    kpiCard("Structure Bias", (r>=6?"Tighten":"Standard"), tagFor(r, x=>x<=4, x=>x<=6), "LTV/LTC/reserves"),
    kpiCard("Cash Mgmt", (r>=6?"Required":"As Needed"), tagFor(r, x=>x<=4, x=>x<=6), "lockbox triggers"),
  ].join("");
  $("kpiPricingGuide").innerHTML = html;
}
function renderRatingNarr(m){
  const lines=[];
  lines.push(`Composite rating is <strong>${m.rating.code}</strong> (${Math.round(m.rating?.code?Number(m.rating.code):0)}), based on leverage, cash flow, sponsor strength, and collateral liquidity.`);
  lines.push(`Key quantitative metrics: LTV ${fmtPct(m.ltv,1)}, LTC ${fmtPct(m.ltc,1)}, DSCR (stabilized) ${fmtX(m.dscrStb,2)}, debt yield ${fmtPct(m.dyStb,2)}.`);
  if(m.forcedCoverage<1.0) lines.push(`Downside: forced sale coverage is ${fmtX(m.forcedCoverage,2)}, indicating ${m.forcedCoverage<0.9?"elevated":"moderate"} loss severity risk.`);
  if(m.globalWithDeal<1.10) lines.push(`Sponsor global DSCR with deal is ${fmtX(m.globalWithDeal,2)}, indicating limited capacity to support the loan under broader stress.`);
  if(m.rec.status!=="Approve") lines.push(`Recommendation is <strong>${escapeHtml(m.rec.status)}</strong> subject to conditions and structure tightening due to identified risks.`);
  $("ratingNarr").innerHTML = `<ul>${lines.map(x=>`<li>${x}</li>`).join("")}</ul>`;
}
function renderMonitoringNarr(m){
  const lines=[];
  lines.push(`Ongoing monitoring should include monthly rent roll: <strong>${escapeHtml($("monRR").value)}</strong>, quarterly financials: <strong>${escapeHtml($("qFin").value)}</strong>, and annual financials: <strong>${escapeHtml($("annFin").value)}</strong>.`);
  lines.push(`Covenants: minimum DSCR ${fmtX(m.covDSCR,2)}; maximum LTV ${fmtPct(m.covLTV,1)}; cash sweep trigger ${fmtX(m.sweep,2)}.`);
  if(m.rec.status!=="Approve") lines.push("Given elevated risks, require more frequent reporting and reserve top-ups if performance deteriorates.");
  $("monNarr").innerHTML = `<ul>${lines.map(x=>`<li>${x}</li>`).join("")}</ul>`;
}
function renderOutputs(o){
  // Exec KPIs
  const k=[];
  const minDSCR = safeNum($("policyMinDSCR").value);
  k.push(kpiCard("Recommendation", escapeHtml(o.rec.status), tagFor(o.rec.status, x=>x==="Approve", x=>x==="Approve with Conditions")));
  k.push(kpiCard("Risk Rating", `${o.rating.code} – ${escapeHtml(o.rating.desc)}`, tagFor(Number(o.rating.code), x=>x<=4, x=>x<=6)));
  k.push(kpiCard("Loan Amount", fmt$(o.loanAmt), tagFor(o.loanAmt, x=>x>0, x=>x>0)));
  k.push(kpiCard("Term / IO", `${o.termMo} / ${o.ioMo} mo`, tagFor(o.ioMo, x=>x>=o.termMo, x=>x>0)));
  k.push(kpiCard("Rate / Points", `${o.noteRate.toFixed(2)}% / ${o.points.toFixed(2)} pts`, tagFor(o.noteRate, x=>x>0, x=>x>0)));
  k.push(kpiCard("LTV (As‑Is)", fmtPct(o.ltv,1), tagFor(o.ltv, x=>x<=70, x=>x<=80)));
  k.push(kpiCard("LTC", fmtPct(o.ltc,1), tagFor(o.ltc, x=>x<=70, x=>x<=80)));
  k.push(kpiCard("DSCR (Stb)", fmtX(o.dscrStb,2), tagFor(o.dscrStb, x=>x>=minDSCR, x=>x>=minDSCR*0.92)));
  k.push(kpiCard("Debt Yield", fmtPct(o.dyStb,2), tagFor(o.dyStb, x=>x>=10, x=>x>=8)));
  k.push(kpiCard("Stress DSCR", fmtX(o.stDSCR,2), tagFor(o.stDSCR, x=>x>=1.00, x=>x>=0.90)));
  k.push(kpiCard("Forced Coverage", fmtX(o.forcedCoverage,2), tagFor(o.forcedCoverage, x=>x>=1.00, x=>x>=0.90)));
  k.push(kpiCard("Global DSCR (w/ deal)", fmtX(o.globalWithDeal,2), tagFor(o.globalWithDeal, x=>x>=1.15, x=>x>=1.05)));
  $("kpiExec").innerHTML = k.join("");

  // Risks/mitigants
  const risks=[], mits=[];
  if(o.ltv>80) risks.push("Elevated leverage increases loss severity risk.");
  else mits.push("Leverage within moderate range.");
  if(o.ltc>80) risks.push("High LTC reduces buffer for overruns/soft cost creep.");
  else mits.push("Sponsor has meaningful equity at risk (LTC acceptable).");
  if(o.dscrStb<minDSCR) risks.push("Stabilized DSCR below policy; takeout risk elevated.");
  else mits.push("Stabilized DSCR provides cushion.");
  if(o.stDSCR<1.0) risks.push("Stress DSCR < 1.00× implies potential payment shortfall under downside case.");
  else mits.push("Stress case remains near/above break-even.");
  if(o.forcedCoverage<0.90) risks.push("Forced sale analysis suggests potential principal impairment net of workout costs.");
  else mits.push("Forced sale proceeds appear sufficient to cover debt.");
  if(o.globalWithDeal<1.05) risks.push("Weak global DSCR indicates limited sponsor backstop under stress.");
  else mits.push("Global cash flow indicates capacity to support debt.");

  $("outRisks").innerHTML = (risks.length?risks:["No material risks identified beyond normal market volatility (based on provided inputs)."]).map(x=>`<li>${escapeHtml(x)}</li>`).join("");
  $("outMitigants").innerHTML = (mits.length?mits:["Mitigants depend on final structure: reserves, draw controls, lower leverage, and verified exit."]).map(x=>`<li>${escapeHtml(x)}</li>`).join("");

  // Exit summary
  const primary = (o.prod==="fixflip") ? "Sale upon renovation completion." :
                  (o.prod==="construction") ? "Sale or refinance upon CO and stabilization." :
                  (o.prod==="dscr") ? "Hold to maturity; refinance only if terms favorable." :
                  "Refinance to permanent debt upon stabilization; sale as secondary.";
  $("outExit").innerHTML = `
    <div class="small">
      <div><span class="chip">Primary Exit</span> ${escapeHtml(primary)}</div>
      <div style="height:6px"></div>
      <div><span class="chip">Exit Value</span> ${fmt$(o.exitValue)} (net sale ${fmt$(o.netSale)}; sale coverage ${fmtX(o.saleCoverage,2)})</div>
      <div style="height:6px"></div>
      <div><span class="chip">Takeout</span> Max takeout ${fmt$(o.maxTakeout)}; takeout LTV ${fmtPct(o.takeoutLTV,1)}</div>
    </div>`;

  // Conditions list
  $("outConds").innerHTML = o.autoConds.map(x=>`<li>${escapeHtml(x)}</li>`).join("");

  // Memo (structured, longer)
  $("memo").innerHTML = buildMemo(o);
}
function buildMemo(o){
  const date = new Date().toLocaleDateString();
  const deal = escapeHtml($("dealName").value||"—");
  const uw = escapeHtml($("underwriter").value||"—");
  const entity = escapeHtml($("borrowerEntity").value||"—");
  const guarantors = escapeHtml($("guarantors").value||"—");
  const addr = escapeHtml($("propAddr").value||"—");
    const submarket = escapeHtml($("submarket").value||"—");
  const assetType = escapeHtml($("assetType").value||"—");
  const purpose = escapeHtml($("loanPurpose").value||"—");
  const narrative = escapeHtml($("txNarr").value||"");
  const lienPos = escapeHtml($("lienPos").value||"—");
  const recourse = escapeHtml($("recourse").value||"—");

  const asIsVal = safeNum($("asIsValue").value);
  const arvVal  = safeNum($("arvValue").value) || asIsVal;

  const srcs = safeNum($("srcLoan").value) + safeNum($("sponsorEquity").value) + safeNum($("otherFin").value);
  const usesOverride = safeNum($("totalUses").value);
  const purchase = safeNum($("purchasePrice").value);
  const borClosing = safeNum($("borClosing").value);
  const rehab = safeNum($("rehabBudget").value);
  const soft = safeNum($("softCosts").value);
  const contPct = safeNum($("contPct").value)/100;
  const contingency = rehab*contPct;
  const estCarry = safeNum($("estCarry").value);
  const leasing = safeNum($("leasingCosts").value);
  const uses = (usesOverride>0) ? usesOverride : (purchase+borClosing+rehab+soft+contingency+estCarry+leasing);

  const titleOk = escapeHtml($("titleOk").value||"Unknown");
  const zoning = escapeHtml($("zoning").value||"Unknown");
  const phaseRes = escapeHtml($("phaseRes").value||"Pending");
  const insOk = escapeHtml($("insOk").value||"Unknown");
  const appRev = escapeHtml($("appRev").value||"No");

  const strengths = escapeHtml($("uwStrengths").value||"");
  const weaknesses = escapeHtml($("uwWeaknesses").value||"");
  const questions = escapeHtml($("uwQuestions").value||"");
  const talking = escapeHtml($("uwTalking").value||"");

  const risks = [];
  const mits = [];

  const minDSCR = safeNum($("policyMinDSCR").value);
  if(o.ltv>80) risks.push("Elevated leverage increases potential loss severity and reduces refinance flexibility.");
  else mits.push("Leverage within a moderate range based on current inputs.");
  if(o.ltc>80) risks.push("High LTC reduces buffer for cost overruns and execution delays.");
  else mits.push("Meaningful sponsor equity at risk supports loss-absorption.");
  if(o.dscrStb<minDSCR) risks.push("Stabilized DSCR below policy indicates elevated takeout and cash-flow risk.");
  else mits.push("Stabilized DSCR meets/exceeds minimum policy threshold.");
  if(o.stDSCR<1.00) risks.push("Downside case produces DSCR < 1.00× indicating potential payment shortfall absent reserves/sponsor support.");
  else mits.push("Downside case remains near/above break-even.");
  if(o.forcedCoverage<0.90) risks.push("Forced-sale coverage suggests potential principal impairment net of workout costs.");
  else mits.push("Forced-sale coverage indicates limited principal impairment risk.");
  if(o.globalWithDeal<1.05) risks.push("Sponsor global cash flow is thin; limited capacity to support the deal through stress.");
  else mits.push("Global cash flow indicates capacity to support the debt under moderate stress.");

  const conds = ($("conds").value||"").split("\n").map(s=>s.trim()).filter(Boolean);

  const section = (title, bodyHtml)=>`
    <div class="card" style="margin-bottom:12px">
      <h3 style="margin-top:0">${title}</h3>
      ${bodyHtml}
    </div>`;

  const bullets = (arr)=> arr.length ? `<ul class="small">${arr.map(x=>`<li>${x}</li>`).join("")}</ul>` : `<div class="small">—</div>`;

  const fmtMaybe = (n)=> (n>0 ? fmt$(n) : "—");

  // Committee-ready memo structure
  let memo = "";

  memo += section("1. Executive Credit Summary",
    `<div class="small">
      <div><span class="chip">Deal</span> <strong>${deal}</strong> · <span class="chip">Date</span> ${date} · <span class="chip">Underwriter</span> ${uw}</div>
      <div style="height:8px"></div>
      <table class="table">
        <tbody>
          <tr><th>Borrower</th><td>${entity}</td><th>Guarantor(s)</th><td>${guarantors}</td></tr>
          <tr><th>Collateral</th><td>${propAddr}</td><th>Product</th><td>${productLabel(o.prod)}</td></tr>
          <tr><th>Purpose</th><td>${purpose}</td><th>Structure</th><td>${lienPos} · ${recourse}</td></tr>
          <tr><th>Recommendation</th><td><strong>${escapeHtml(o.rec.status)}</strong></td><th>Risk Rating</th><td><strong>${o.rating.code}</strong> – ${escapeHtml(o.rating.desc)}</td></tr>
        </tbody>
      </table>
      ${o.rec.rationale?.length ? `<div style="margin-top:8px" class="warnbox"><strong>Rationale:</strong> ${escapeHtml(o.rec.rationale.join(" "))}</div>` : ""}
    </div>`);

  memo += section("2. Transaction Overview",
    `<div class="small">
      <div><strong>Business plan narrative:</strong></div>
      <div style="margin-top:6px">${narrative ? narrative : "<em>No narrative provided.</em>"}</div>
      <div class="hr"></div>
      <table class="table">
        <tbody>
          <tr><th>Loan Amount</th><td class="mono right">${fmt$(o.loanAmt)}</td><th>Term / IO</th><td class="mono right">${o.termMo} / ${o.ioMo} mo</td></tr>
          <tr><th>Rate / Points</th><td class="mono right">${o.noteRate.toFixed(2)}% / ${o.points.toFixed(2)} pts</td><th>Est. Debt Service (annual)</th><td class="mono right">${fmt$(o.dsAnnual)}</td></tr>
        </tbody>
      </table>
    </div>`);

  memo += section("3. Sources & Uses",
    `<div class="small">
      <table class="table">
        <thead><tr><th>Uses</th><th class="right">Amount</th><th>Sources</th><th class="right">Amount</th></tr></thead>
        <tbody>
          <tr><td>Purchase</td><td class="mono right">${fmtMaybe(purchase)}</td><td>Loan Proceeds</td><td class="mono right">${fmtMaybe(safeNum($("srcLoan").value))}</td></tr>
          <tr><td>Borrower Closing</td><td class="mono right">${fmtMaybe(borClosing)}</td><td>Sponsor Equity</td><td class="mono right">${fmtMaybe(safeNum($("sponsorEquity").value))}</td></tr>
          <tr><td>Hard Costs</td><td class="mono right">${fmtMaybe(rehab)}</td><td>Other Financing</td><td class="mono right">${fmtMaybe(safeNum($("otherFin").value))}</td></tr>
          <tr><td>Soft Costs</td><td class="mono right">${fmtMaybe(soft)}</td><td></td><td></td></tr>
          <tr><td>Contingency</td><td class="mono right">${fmtMaybe(contingency)}</td><td></td><td></td></tr>
          <tr><td>Interest Carry (est.)</td><td class="mono right">${fmtMaybe(estCarry)}</td><td></td><td></td></tr>
          <tr><td>Leasing / TI / LC</td><td class="mono right">${fmtMaybe(leasing)}</td><td></td><td></td></tr>
          <tr><th>Total Uses</th><th class="mono right">${fmt$(uses)}</th><th>Total Sources</th><th class="mono right">${fmt$(srcs)}</th></tr>
        </tbody>
      </table>
      ${Math.abs(srcs-uses)>100 ? `<div class="badbox"><strong>Gap:</strong> Sources and uses do not reconcile. Address prior to approval/closing.</div>` : ""}
    </div>`);

  memo += section("4. Collateral & Market",
    `<div class="small">
      <table class="table">
        <tbody>
          <tr><th>Address</th><td>${propAddr}</td><th>Submarket</th><td>${submarket}</td></tr>
          <tr><th>Asset Type</th><td>${assetType}</td><th>Liquidity (1–5)</th><td class="mono">${escapeHtml($("liqScore").value||"—")}</td></tr>
          <tr><th>As-Is Value</th><td class="mono right">${fmt$(asIsVal)}</td><th>Stabilized/ARV</th><td class="mono right">${fmt$(arvVal)}</td></tr>
        </tbody>
      </table>
      <div class="hr"></div>
      <div><strong>Market support:</strong></div>
      <div style="margin-top:6px"><em>Rent comps:</em> ${escapeHtml($("rentComps").value||"—")}</div>
      <div style="margin-top:6px"><em>Sale comps:</em> ${escapeHtml($("saleComps").value||"—")}</div>
    </div>`);

  memo += section("5. Historical Performance (if applicable)",
    `<div class="small">
      <table class="table">
        <tbody>
          <tr><th>NOI (Normalized)</th><td class="mono right">${fmt$(o.noi)}</td><th>DSCR (In-Place)</th><td class="mono right">${fmtX(o.dscrHist,2)}</td></tr>
          <tr><th>Breakeven</th><td class="mono right">${fmtPct(o.breakeven,1)}</td><th>Debt Yield (In-Place)</th><td class="mono right">${fmtPct(safeDiv(o.noi,o.loanAmt)*100,2)}</td></tr>
        </tbody>
      </table>
      <div class="footerNote">Historical results should be tied to bank statements / operating statements; normalize vacancy, management, and reserves.</div>
    </div>`);

  memo += section("6. Underwritten Pro Forma & Exit",
    `<div class="small">
      <table class="table">
        <tbody>
          <tr><th>Stabilized NOI</th><td class="mono right">${fmt$(o.stbNOI)}</td><th>DSCR (Stabilized)</th><td class="mono right">${fmtX(o.dscrStb,2)}</td></tr>
          <tr><th>Debt Yield (Stabilized)</th><td class="mono right">${fmtPct(o.dyStb,2)}</td><th>Exit Value (Cons.)</th><td class="mono right">${fmt$(o.exitValue)}</td></tr>
          <tr><th>Sale Coverage</th><td class="mono right">${fmtX(o.saleCoverage,2)}</td><th>Max Takeout</th><td class="mono right">${fmt$(o.maxTakeout)}</td></tr>
          <tr><th>Takeout LTV</th><td class="mono right">${fmtPct(o.takeoutLTV,1)}</td><th>Implied Sale Loss</th><td class="mono right">${fmt$(o.impliedSaleLoss)}</td></tr>
        </tbody>
      </table>
      <div class="footerNote">Exit value uses cap rate + buffer. Takeout sizing uses DSCR requirement and takeout rate/amort assumptions.</div>
    </div>`);

  memo += section("7. Stress Testing & Loss Severity",
    `<div class="small">
      <table class="table">
        <tbody>
          <tr><th>Stress DSCR</th><td class="mono right">${fmtX(o.stDSCR,2)}</td><th>Forced Sale Coverage</th><td class="mono right">${fmtX(o.forcedCoverage,2)}</td></tr>
          <tr><th>Forced Sale Loss</th><td class="mono right">${fmt$(o.forcedLoss)}</td><th>Committee View</th><td>${(o.forcedCoverage<1.0||o.stDSCR<1.0)?"Elevated downside; structure/mitigants required.":"Downside appears manageable based on inputs."}</td></tr>
        </tbody>
      </table>
      <div class="footerNote">Forced sale is a practical private-credit loss path; underwrite buyer pool and time-to-exit conservatively.</div>
    </div>`);

  memo += section("8. Sponsor / Guarantor Support",
    `<div class="small">
      <table class="table">
        <tbody>
          <tr><th>Adj. Liquidity</th><td class="mono right">${fmt$(o.adjLiq)}</td><th>Adj. Net Worth</th><td class="mono right">${fmt$(o.adjNW)}</td></tr>
          <tr><th>Liquidity After Delay Burn</th><td class="mono right">${fmt$(o.liqAfterBurn)}</td><th>Est. Delay Burn</th><td class="mono right">${fmt$(o.liqBurn)}</td></tr>
          <tr><th>Global DSCR (w/ deal)</th><td class="mono right">${fmtX(o.globalWithDeal,2)}</td><th>Recourse</th><td>${recourse}</td></tr>
        </tbody>
      </table>
      <div class="footerNote">Sponsor metrics are conservative (haircuts). For institutional approval, attach full PFS and schedule of RE owned.</div>
    </div>`);

  memo += section("9. Collateral & Legal / Diligence",
    `<div class="small">
      <table class="table">
        <tbody>
          <tr><th>Title Acceptable</th><td>${titleOk}</td><th>Zoning Verified</th><td>${zoning}</td></tr>
          <tr><th>Environmental</th><td>${phaseRes}</td><th>Insurance Adequate</th><td>${insOk}</td></tr>
          <tr><th>Appraisal Reviewed</th><td>${appRev}</td><th></th><td></td></tr>
        </tbody>
      </table>
      <div style="margin-top:8px"><strong>Diligence notes / conditions:</strong></div>
      <div style="margin-top:6px">${escapeHtml($("legalConds").value||"—")}</div>
    </div>`);

  memo += section("10. Key Risks & Mitigants",
    `<div class="small">
      <div class="grid2" style="gap:10px">
        <div><strong>Risks</strong>${bullets(risks)}</div>
        <div><strong>Mitigants</strong>${bullets(mits)}</div>
      </div>
    </div>`);

  memo += section("11. Conditions / Covenants / Monitoring",
    `<div class="small">
      ${conds.length ? `<ul class="small">${conds.map(c=>`<li>${escapeHtml(c)}</li>`).join("")}</ul>` : "<em>No conditions provided.</em>"}
      <div class="hr"></div>
      <div><strong>Reporting:</strong> Monthly rent roll: ${escapeHtml($("monRR").value)} · Quarterly financials: ${escapeHtml($("qFin").value)} · Annual financials: ${escapeHtml($("annFin").value)} · Construction reporting: ${escapeHtml($("constRpt").value)}</div>
    </div>`);

  memo += section("12. Underwriter Notes (for committee discussion)",
    `<div class="small">
      <div><strong>Strengths:</strong></div><div style="margin-top:6px">${strengths||"—"}</div>
      <div style="height:10px"></div>
      <div><strong>Weaknesses:</strong></div><div style="margin-top:6px">${weaknesses||"—"}</div>
      <div style="height:10px"></div>
      <div><strong>Key Questions:</strong></div><div style="margin-top:6px">${questions||"—"}</div>
      <div style="height:10px"></div>
      <div><strong>Talking Points:</strong></div><div style="margin-top:6px">${talking||"—"}</div>
    </div>`);

  return memo;
}

/* =========================================================
   File Quality / Feedback Engine
========================================================= */
function renderQuality(m){
  const flags=[];
  const tips=[];

  // Missing core items
  if(!m.deal || m.deal==="—") flags.push({lvl:"bad", txt:"Deal name is blank (audit trail / exports will be weak)."});
  if(m.loanAmt<=0) flags.push({lvl:"bad", txt:"Loan amount is not entered; downstream metrics are not meaningful."});
  if(m.asIs<=0) flags.push({lvl:"bad", txt:"As-is value is missing; leverage cannot be validated."});
  if(m.stbNOI<=0) flags.push({lvl:"warn", txt:"Stabilized NOI is missing/zero; takeout and exit math will be unreliable."});
  if(!m.txNarr || m.txNarr.trim().length<120) flags.push({lvl:"warn", txt:"Transaction narrative is thin. Committee memos should clearly state purpose, plan, and exit."});
  if(!m.rentComps || m.rentComps.trim().length<60) flags.push({lvl:"warn", txt:"Rent comp support is thin. Stabilized rents should be defensible."});
  if(!m.saleComps || m.saleComps.trim().length<60) flags.push({lvl:"warn", txt:"Sale comp / cap rate support is thin. Exit assumptions should be supported."});

  // Diligence readiness
  if(m.titleOk==="No") flags.push({lvl:"bad", txt:"Title marked not acceptable. This is typically a gating issue."});
  if(m.zoning==="No") flags.push({lvl:"bad", txt:"Zoning/use not verified. Confirm prior to closing."});
  if(m.phaseRes==="RECs Identified") flags.push({lvl:"warn", txt:"Environmental RECs identified. Confirm mitigations / Phase II where needed."});
  if(m.insOk==="No") flags.push({lvl:"bad", txt:"Insurance not adequate. This is a closing requirement."});
  if(m.appRev==="No") flags.push({lvl:"warn", txt:"Appraisal not reviewed. Provide internal review and reconcile to underwriting."});

  // Credit quality suggestions
  if(m.rec.status!=="Approve"){
    tips.push("Translate each key risk into an enforceable mitigant: lower leverage, reserves, covenants, cash management, or additional collateral.");
    tips.push("Tighten assumptions rather than trying to 'solve' with pricing. Private credit wins by avoiding loss severity, not by maximizing coupon.");
  }
  if(m.rating.code>="6"){
    tips.push("For high-risk grades, consider: (i) lender-controlled contingency, (ii) interest reserve sized to stabilization + buffer, (iii) PG + liquidity covenant, (iv) milestone-based curtailments.");
  }
  if(m.maxTakeout<m.loanAmt && m.loanAmt>0){
    tips.push("Exit feasibility: permanent takeout (by DSCR) does not size to repay the loan. Require lower loan amount, verified sale exit, or additional equity.");
  }
  if(m.forcedCoverage<1.0){
    tips.push("Loss severity: forced-sale proceeds may not repay debt. Reduce leverage and/or require additional collateral, guarantees, and reserves.");
  }

  const renderFlag = (f)=>{
    const cls = f.lvl==="bad" ? "badbox" : (f.lvl==="warn" ? "warnbox" : "callout");
    return `<div class="${cls}" style="margin-bottom:8px"><strong>${f.lvl.toUpperCase()}:</strong> ${escapeHtml(f.txt)}</div>`;
  };

  const html = `
    ${flags.length ? flags.map(renderFlag).join("") : `<div class="callout"><strong>Good:</strong> No major file-quality flags detected based on current inputs.</div>`}
    <div class="hr"></div>
    <div class="callout">
      <strong>Suggested Improvements:</strong>
      <ul>
        ${(tips.length?tips:[
          "Add exhibits: rent roll, T-12, appraisal/BPO, title, insurance binder, budget, sponsor PFS, and exit comps.",
          "If value-add/construction: attach GC contract, schedule, draw controls, and third-party budget review."
        ]).map(t=>`<li>${escapeHtml(t)}</li>`).join("")}
      </ul>
    </div>`;
  $("qualityFlags").innerHTML = html;
}

/* =========================================================
   Initialization / Events
========================================================= */
function wire(){
  // Navigation
  qsa("#nav button").forEach(b=>{
    b.addEventListener("click", ()=> showPage(b.dataset.page));
  });

  // Buttons
  $("btnRecalc").addEventListener("click", calc);
  $("btnSave").addEventListener("click", save);
  $("btnExport").addEventListener("click", exportJSON);
  $("btnImport").addEventListener("click", importJSON);
  $("btnClear").addEventListener("click", clearAll);
  $("btnPrint").addEventListener("click", ()=>{ showPage("p_outputs"); setTimeout(()=>window.print(), 150); });

  // Tables
  $("addRR").addEventListener("click", addRR);
  $("sumRR").addEventListener("click", sumRR);
  $("addGlob").addEventListener("click", addGlob);
  $("sumGlob").addEventListener("click", sumGlob);
  $("addDraw").addEventListener("click", addDraw);
  $("evenDraw").addEventListener("click", evenDraw);

  // Product change -> defaults
  $("loanProduct").addEventListener("change", (e)=>{
    applyDefaults(e.target.value);
    calc();
  });

  // Auto recalc on input changes (debounced)
  let t=null;
  qsa("input,select,textarea").forEach(el=>{
    el.addEventListener("input", ()=>{
      clearTimeout(t);
      t=setTimeout(calc, 120);
    });
    el.addEventListener("change", ()=>{
      clearTimeout(t);
      t=setTimeout(calc, 120);
    });
  });
}

function boot(){
  // Default dates
  if(!$("uwDate").value) $("uwDate").value = todayISO();
  if(!$("closeDate").value) $("closeDate").value = "";

  // Load saved state if present
  const loaded = load();
  if(!loaded){
    applyDefaults($("loanProduct").value);
  }

  // Render empty tables if needed
  renderRR(); renderGlob(); renderDraws();

  // Wire events and calc
  wire();
  calc();
}

boot();
/* ===== Inputs vs Outputs Mode ===== */
(function () {
  function letterFromLabel(text) {
    const m = String(text || "").trim().match(/^([A-O])\s*\./i);
    return m ? m[1].toUpperCase() : null;
  }

  function isInputsLetter(letter) {
    // A–H = Inputs, I–O = Outputs
    if (!letter) return true;
    return letter.charCodeAt(0) <= "H".charCodeAt(0);
  }

  function setMode(mode) {
    const isInputs = mode === "inputs";

    // Badge + button styling
    const badge = document.getElementById("modeBadge");
    const bIn = document.getElementById("btnModeInputs");
    const bOut = document.getElementById("btnModeOutputs");
    if (badge) badge.textContent = "Mode: " + (isInputs ? "Inputs" : "Outputs");
    if (bIn && bOut) {
      bIn.classList.toggle("active", isInputs);
      bOut.classList.toggle("active", !isInputs);
    }

    // Sidebar: hide/show buttons based on A–H vs I–O
    const sidebar = document.querySelector("aside") || document.querySelector(".sidebar") || document.body;
    const navButtons = sidebar.querySelectorAll("button, a");
    navButtons.forEach((el) => {
      const t = (el.textContent || "").trim();
      const L = letterFromLabel(t);
      if (!L) return;
      const show = isInputs ? isInputsLetter(L) : !isInputsLetter(L);
      el.style.display = show ? "" : "none";
    });

    // Main content: hide/show sections based on their first heading (A.–O.)
    // This works if your sections contain an H2/H3 like "A. Deal Setup"
    const sections = document.querySelectorAll("section, .section, .page, .panel");
    sections.forEach((sec) => {
      const h = sec.querySelector("h1,h2,h3,h4");
      const L = letterFromLabel(h ? h.textContent : "");
      if (!L) return;
      const show = isInputs ? isInputsLetter(L) : !isInputsLetter(L);
      sec.style.display = show ? "" : "none";
    });

    // Persist
    try { localStorage.setItem("uo_mode", mode); } catch (e) {}
  }

  // Wire up buttons
  document.addEventListener("DOMContentLoaded", function () {
    const bIn = document.getElementById("btnModeInputs");
    const bOut = document.getElementById("btnModeOutputs");

    if (bIn) bIn.addEventListener("click", () => setMode("inputs"));
    if (bOut) bOut.addEventListener("click", () => setMode("outputs"));

    let saved = "inputs";
    try { saved = localStorage.getItem("uo_mode") || "inputs"; } catch (e) {}
    setMode(saved);
  });
})();

</script>

</body>
</html>
